# Story 3.4: Multi-Agent Management View

## Status
Ready for Review

## Story
**As a** System Operator,
**I want** to see all active agents for my tenant on the dashboard,
**so that** I can monitor my entire fleet from one place.

## Acceptance Criteria
1. Dashboard includes an "Agents" list showing `agent_id`, `status` (Online/Offline), and `last_seen`.
2. "Status" logic is based on the frequency of MQTT messages (e.g., Offline if no message in > 60 seconds).
3. Clicking an agent filters the main dashboard charts to show only that agent's metrics on the Tenant Detail page.
4. Tenant Detail page replaces placeholders with functional `RealtimeChart` components.
5. Real-time charts correctly handle the metrics from the Go agent: `cpu.usage.percent`, `memory.used.bytes`, and `disk.usage.percent`.

## Tasks / Subtasks
- [x] Task 1: Update Dashboard Controller (AC: 1, 2)
    - [x] Modify `app/app/Http/Controllers/DashboardController.php` to calculate `last_seen` and `status` for each agent.
    - [x] Use `DB::raw('MAX(timestamp)')` to find the last reported metric for each `agent_id`.
    - [x] Implement status logic: "Online" if `last_seen` is within the last 60 seconds, otherwise "Offline".
- [x] Task 2: Enhance Realtime Chart Component (AC: 4, 5)
    - [x] Update `app/resources/js/Components/RealtimeChart.vue` to support an optional `agentId` prop.
    - [x] Update `handleData` logic to:
        - Handle the payload format from `ProcessMetricSubmission` (array of objects).
        - Match `metric_name` key (instead of `metric`).
        - Filter by `agentId` if the prop is provided.
- [x] Task 3: Update Dashboard Overview Page (AC: 1, 3)
    - [x] Update `app/resources/js/Pages/Dashboard/Overview.vue` to display the `last_seen` timestamp for each agent.
    - [x] Ensure the status badge reflects the "Online"/"Offline" status correctly (e.g., gray for offline).
- [x] Task 4: Integrate Charts into Tenant Detail Page (AC: 3, 4, 5)
    - [x] Update `app/resources/js/Pages/Dashboard/TenantDetail.vue` to import and use `RealtimeChart.vue`.
    - [x] Replace placeholders for CPU, Memory, and Disk with `RealtimeChart` instances.
    - [x] Pass the `agent_id` filter (from query params) to the `RealtimeChart` components.
    - [x] Configure charts for the specific Go agent metrics: `cpu.usage.percent`, `memory.used.bytes`, `disk.usage.percent`.

## Dev Notes
- **Metric Names**: The Go agent uses `cpu.usage.percent`, `memory.used.bytes`, and `disk.usage.percent`. [Source: agent/cmd/agent/main.go]
- **SSE Payload Format**: `ProcessMetricSubmission` publishes an array of objects to Redis: `[{ "agent_id": "...", "metric_name": "...", "value": 123, "timestamp": "..." }]`. [Source: app/app/Jobs/ProcessMetricSubmission.php]
- **Previous Story Insights**:
    - `RealtimeChart.vue` uses `Chart.js` with `animation: false` and `update('none')` for performance. [Source: docs/stories/2.3.reactive-metric-chart-component.story.md]
    - `StreamService` is a singleton that handles the SSE connection for a tenant. [Source: app/resources/js/Services/StreamService.ts]
- **Architecture**:
    - Dashboard logic is in `DashboardController`. [Source: docs/architecture/2-high-level-architecture.md]
    - Frontend uses Vue 3 + Tailwind. [Source: docs/architecture/3-tech-stack.md]
- **Performance**:
    - Use `MAX(timestamp)` with `groupBy` in the controller. Ensure `idx_tenant_metric_time` is utilized. [Source: docs/architecture/11-checklist-results-report.md]

### Testing
- **Test File Location**: `app/resources/js/Components/__tests__/RealtimeChart.test.ts`
- **Test Standards**: Vitest for frontend components. Standard PHPUnit for Controller logic.
- **Testing Frameworks**: Vitest, `@vue/test-utils`, PHPUnit.
- **Verification Scenarios**:
    - Start the Go agent and verify it appears in the Dashboard Overview with "Online" status.
    - Stop the Go agent and verify status changes to "Offline" after 60 seconds (upon refresh).
    - Click on an agent and verify that the Tenant Detail page charts only show data for that specific agent.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-18 | 1.0 | Initial Story Draft | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
- No blocking issues encountered

### Completion Notes List
- Updated DashboardController to calculate agent status based on last_seen timestamp (Online if within 60 seconds)
- Enhanced RealtimeChart component to support agentId filtering and handle ProcessMetricSubmission payload format
- Updated Dashboard Overview to display last_seen timestamps with conditional status badges
- Integrated functional RealtimeChart components into Tenant Detail page for CPU, Memory, and Disk metrics
- All PHPUnit tests pass (53 tests)
- All Vitest tests pass (39 tests)

### File List
- app/app/Http/Controllers/DashboardController.php (modified)
- app/tests/Feature/DashboardTest.php (modified)
- app/resources/js/Components/RealtimeChart.vue (modified)
- app/resources/js/Components/__tests__/RealtimeChart.test.ts (modified)
- app/resources/js/Pages/Dashboard/Overview.vue (modified)
- app/resources/js/Pages/Dashboard/TenantDetail.vue (modified) 

## QA Results
