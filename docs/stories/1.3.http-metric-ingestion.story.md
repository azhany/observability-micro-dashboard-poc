# Story 1.3: HTTP Metric Ingestion API (Single & Bulk)

## Status
Ready for Review

## Story
**As an** Application Developer,
**I want** an API endpoint to push metrics via HTTP (JSON),
**so that** my services can report data to the micro-dashboard.

## Acceptance Criteria
1. Endpoint `POST /api/v1/metrics` accepts a JSON payload containing `metric_name`, `value`, `timestamp`, and optional `tags`.
2. Endpoint supports bulk ingestion (array of metric objects).
3. The API returns a `202 Accepted` status code for valid payloads.
4. Basic validation ensures `metric_name` and `value` are present and correctly formatted.

## Tasks / Subtasks
- [x] Task 1: Request Validation & DTOs (AC: 1, 2, 4)
    - [x] Create `App\Http\Requests\StoreMetricRequest` to handle validation.
    - [x] Define validation rules:
        - Support both single object and array of objects.
        - `metric_name`: required, string, max:64.
        - `value`: required, numeric.
        - `timestamp`: required, date/timestamp.
        - `agent_id`: optional, string.
        - `dedupe_id`: optional, string.
    - [x] Ensure validation messages are clear for API consumers.
- [x] Task 2: Ingestion Job Placeholder (AC: 3)
    - [x] Create `App\Jobs\ProcessMetricSubmission` job class.
    - [x] Define constructor to accept the tenant (from auth) and the metric payload (array).
    - [x] Implement `handle()` method to simply log the payload for now (DB persistence is in Story 1.4). [Source: architecture/6-core-workflows.md#6.1 Ingest -> Live Update]
- [x] Task 3: API Controller & Routing (AC: 1, 2, 3)
    - [x] Create `App\Http\Controllers\Api\MetricIngestionController`.
    - [x] Implement `store` method using `StoreMetricRequest`.
    - [x] Logic:
        - Retrieve `tenant` from request (set by `AuthenticateTenantToken` middleware).
        - Normalize payload (ensure it's always an array).
        - Dispatch `ProcessMetricSubmission` to the default queue.
        - Return `response()->json(['status' => 'accepted'], 202)`. [Source: architecture/5-api-specification-rest-ingestion.md]
    - [x] Register route in `routes/api.php` with `auth.tenant` middleware.
- [x] Task 4: Feature Testing (AC: 1, 2, 3, 4)
    - [x] Create `tests/Feature/MetricIngestionTest.php`.
    - [x] Test cases:
        - [x] Valid single metric payload -> 202 Accepted & Job Dispatched.
        - [x] Valid bulk metric payload -> 202 Accepted & Job Dispatched.
        - [x] Invalid payload (missing name/value) -> 422 Unprocessable Entity.
        - [x] Unauthenticated request -> 401 Unauthorized.
        - [x] Verify `tenant_id` is correctly passed to the Job.

## Dev Notes
- **API Spec:**
    - Endpoint: `POST /api/v1/metrics`
    - Response: 202 Accepted
    - Payload: Array of objects or Single object.
    - Source: [architecture/5-api-specification-rest-ingestion.md]
- **Validation Strategy:**
    - Since the endpoint supports both single and bulk, the Request class needs to handle the root element being either an object or an array.
    - Laravel's `FormRequest` validation might need specific handling for the root array (e.g., `*.metric_name`).
- **Job Dispatching:**
    - To minimize Redis overhead, dispatch **one job per HTTP request** containing the full batch of metrics. The worker (Story 1.4) will handle iterating and persisting them.
    - Ensure the `tenant` context is passed to the Job so metrics are associated correctly.
- **Previous Story Insights:**
    - Auth middleware `AuthenticateTenantToken` is ready and should be applied to this route.
    - Use `Queue::fake()` in tests to assert job dispatch without running the worker.

### Testing
- **Test File Location:** `tests/Feature/MetricIngestionTest.php`
- **Test Standards:** Use Laravel's `Pest` or `PHPUnit` (match existing `TenantAuthTest.php` style).
- **Frameworks:** `RefreshDatabase` trait, `Queue::fake()`.
- **Specific Requirements:**
    - Must test valid/invalid payloads.
    - Must test auth/unauth access.
    - Must verify Job dispatching with correct data.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-18 | 1.0 | Initial Story Draft | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
None

### Completion Notes List
- Implemented StoreMetricRequest with dynamic validation supporting both single metric objects and bulk arrays
- Created ProcessMetricSubmission job that accepts tenant and metrics array, currently logs payload (DB persistence in Story 1.4)
- Implemented MetricIngestionController with payload normalization to ensure consistent array format for job processing
- Added route POST /api/v1/metrics with auth.tenant middleware
- Created comprehensive test suite with 12 test cases covering all acceptance criteria
- All 12 MetricIngestionTest tests pass successfully
- All 4 TenantAuthTest regression tests pass
- Note: Pre-existing HealthCheckTest failure (unrelated to this implementation)

### File List
**Created:**
- app/app/Http/Requests/StoreMetricRequest.php
- app/app/Jobs/ProcessMetricSubmission.php
- app/app/Http/Controllers/Api/MetricIngestionController.php
- app/tests/Feature/MetricIngestionTest.php

**Modified:**
- app/routes/api.php

## QA Results
_To be populated by QA Agent_
