# Story 1.3: HTTP Metric Ingestion API (Single & Bulk)

## Status
Done

## Story
**As an** Application Developer,
**I want** an API endpoint to push metrics via HTTP (JSON),
**so that** my services can report data to the micro-dashboard.

## Acceptance Criteria
1. Endpoint `POST /api/v1/metrics` accepts a JSON payload containing `metric_name`, `value`, `timestamp`, and optional `tags`.
2. Endpoint supports bulk ingestion (array of metric objects).
3. The API returns a `202 Accepted` status code for valid payloads.
4. Basic validation ensures `metric_name` and `value` are present and correctly formatted.

## Tasks / Subtasks
- [x] Task 1: Request Validation & DTOs (AC: 1, 2, 4)
    - [x] Create `App\Http\Requests\StoreMetricRequest` to handle validation.
    - [x] Define validation rules:
        - Support both single object and array of objects.
        - `metric_name`: required, string, max:64.
        - `value`: required, numeric.
        - `timestamp`: required, date/timestamp.
        - `agent_id`: optional, string.
        - `dedupe_id`: optional, string.
    - [x] Ensure validation messages are clear for API consumers.
- [x] Task 2: Ingestion Job Placeholder (AC: 3)
    - [x] Create `App\Jobs\ProcessMetricSubmission` job class.
    - [x] Define constructor to accept the tenant (from auth) and the metric payload (array).
    - [x] Implement `handle()` method to simply log the payload for now (DB persistence is in Story 1.4). [Source: architecture/6-core-workflows.md#6.1 Ingest -> Live Update]
- [x] Task 3: API Controller & Routing (AC: 1, 2, 3)
    - [x] Create `App\Http\Controllers\Api\MetricIngestionController`.
    - [x] Implement `store` method using `StoreMetricRequest`.
    - [x] Logic:
        - Retrieve `tenant` from request (set by `AuthenticateTenantToken` middleware).
        - Normalize payload (ensure it's always an array).
        - Dispatch `ProcessMetricSubmission` to the default queue.
        - Return `response()->json(['status' => 'accepted'], 202)`. [Source: architecture/5-api-specification-rest-ingestion.md]
    - [x] Register route in `routes/api.php` with `auth.tenant` middleware.
- [x] Task 4: Feature Testing (AC: 1, 2, 3, 4)
    - [x] Create `tests/Feature/MetricIngestionTest.php`.
    - [x] Test cases:
        - [x] Valid single metric payload -> 202 Accepted & Job Dispatched.
        - [x] Valid bulk metric payload -> 202 Accepted & Job Dispatched.
        - [x] Invalid payload (missing name/value) -> 422 Unprocessable Entity.
        - [x] Unauthenticated request -> 401 Unauthorized.
        - [x] Verify `tenant_id` is correctly passed to the Job.

## Dev Notes
- **API Spec:**
    - Endpoint: `POST /api/v1/metrics`
    - Response: 202 Accepted
    - Payload: Array of objects or Single object.
    - Source: [architecture/5-api-specification-rest-ingestion.md]
- **Validation Strategy:**
    - Since the endpoint supports both single and bulk, the Request class needs to handle the root element being either an object or an array.
    - Laravel's `FormRequest` validation might need specific handling for the root array (e.g., `*.metric_name`).
- **Job Dispatching:**
    - To minimize Redis overhead, dispatch **one job per HTTP request** containing the full batch of metrics. The worker (Story 1.4) will handle iterating and persisting them.
    - Ensure the `tenant` context is passed to the Job so metrics are associated correctly.
- **Previous Story Insights:**
    - Auth middleware `AuthenticateTenantToken` is ready and should be applied to this route.
    - Use `Queue::fake()` in tests to assert job dispatch without running the worker.

### Testing
- **Test File Location:** `tests/Feature/MetricIngestionTest.php`
- **Test Standards:** Use Laravel's `Pest` or `PHPUnit` (match existing `TenantAuthTest.php` style).
- **Frameworks:** `RefreshDatabase` trait, `Queue::fake()`.
- **Specific Requirements:**
    - Must test valid/invalid payloads.
    - Must test auth/unauth access.
    - Must verify Job dispatching with correct data.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-18 | 1.0 | Initial Story Draft | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929) and Claude Haiku 4.5 (for QA review)

### Debug Log References
- PHP Syntax Check: ✓ No syntax errors detected for modified files
- Tests: ✓ 18 passed (1 unrelated health check failure)
  - All metric ingestion tests pass
  - All authentication tests pass
  - Rate limiting and bulk validation ready for QA testing

### Completion Notes List
- Implemented StoreMetricRequest with dynamic validation supporting both single metric objects and bulk arrays
- Created ProcessMetricSubmission job that accepts tenant and metrics array, currently logs payload (DB persistence in Story 1.4)
- Implemented MetricIngestionController with payload normalization to ensure consistent array format for job processing
- Added route POST /api/v1/metrics with auth.tenant middleware
- Created comprehensive test suite with 12 test cases covering all acceptance criteria
- All 12 MetricIngestionTest tests pass successfully
- All 4 TenantAuthTest regression tests pass
- Note: Pre-existing HealthCheckTest failure (unrelated to this implementation)

**Changes Applied:**
1. **SEC-001 (High - Rate Limiting):** Applied `throttle:60,1` middleware to POST `/api/v1/metrics` route in `routes/api.php` to prevent DoS attacks. Limits requests to 60 per minute per tenant.

2. **PERF-001 (Medium - Bulk Size Limit):** Added validation rule to limit maximum array size to 1000 items in `StoreMetricRequest.php`. Root array now validated with `array|max:1000` constraint with custom error message.

**Testing Results:**
- All existing metric ingestion tests pass with new validation
- No regressions detected
- Rate limiting behavior ready for QA load testing (test case 1.3-INT-003)

### File List

**Modified Files:**
- `app/routes/api.php` - Added throttle middleware
- `app/app/Http/Requests/StoreMetricRequest.php` - Added bulk array size validation

### Change Log

**2026-01-18 - QA Fixes Applied**
- Implemented rate limiting middleware (SEC-001) to prevent DoS
- Implemented maximum bulk payload size validation (PERF-001) with 1000 item limit
- All high-risk findings from QA gate now addressed
- Ready for QA re-review

## QA Results

### Review Date: 2026-01-18

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation is solid and strictly follows the Acceptance Criteria. The use of a single Request class to handle both single and bulk payloads is elegant. The Controller logic is clean, and the Job dispatching correctly isolates tenant context.

However, significant Non-Functional Requirement (NFR) gaps were identified during the Risk Assessment that have not been addressed in the code.

### Refactoring Performed

None. The functional code is correct.

### Compliance Check

- Coding Standards: [✓]
- Project Structure: [✓]
- Testing Strategy: [✓] Comprehensive feature tests covering positive and negative cases.
- All ACs Met: [✓] Functionally met.

### Improvements Checklist

- [x] **CRITICAL (SEC-001):** Add rate limiting middleware (e.g., `throttle:60,1`) to the route in `routes/api.php` to prevent DoS.
- [x] **IMPORTANT (PERF-001):** Add a validation rule to limit the maximum number of items in a bulk array (e.g., `max:1000`) in `StoreMetricRequest`.
- [ ] Consider adding a `Content-Length` check at the server level (Nginx/PHP) for very large payloads, but app-level validation is a good first step.

### Security Review

- **Auth:** `auth.tenant` middleware is correctly applied.
- **Tenant Isolation:** Tenant ID is correctly passed to the Job, preventing context leakage.
- **Rate Limiting:** `throttle:60,1` successfully implemented to protect the endpoint.

### Performance Considerations

- **Bulk Ingestion:** The `process` job currently logs the payload. When DB persistence is added (Story 1.4), ensure the worker handles large batches efficiently (e.g., `insert` instead of loop-create).
- **Validation:** Bulk array size is now capped at 1000 items, mitigating potential OOM risks.

### Files Modified During Review

None.

### Gate Status

Gate: PASS → docs/qa/gates/1.3.http-metric-ingestion-api.yml
Risk profile: docs/qa/assessments/1.3-risk-20260118.md
Test design: docs/qa/assessments/1.3-test-design-20260118.md

### Recommended Status

[✓ Ready for Done] - High-risk findings have been addressed.

### Review Date: 2026-01-18 (Re-review)

### Reviewed By: Quinn (Test Architect)

### Re-review Assessment
The developer has successfully addressed the concerns raised in the initial review:
- **SEC-001:** Rate limiting middleware (`throttle:60,1`) has been applied to the metrics ingestion route.
- **PERF-001:** Bulk payload validation now correctly enforces a maximum of 1000 items.

All tests remain passing. The story is now of high quality and ready for the next stage.

### Gate Status
Gate: PASS
Status: Ready for Done
