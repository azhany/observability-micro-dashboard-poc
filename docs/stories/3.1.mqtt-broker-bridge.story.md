# Story 3.1: MQTT Broker & Bridge Infrastructure

## Status
Ready for Development

## Story
**As a** System Operator,
**I want** an MQTT broker (Mosquitto) integrated into the environment,
**so that** I can ingest metrics from edge devices.

## Acceptance Criteria
1. Mosquitto container added to `docker-compose.yml`.
2. A "Bridge" service (either a separate Go process or a Laravel Artisan command) subscribes to `metrics/#`.
3. The bridge parses the topic structure `metrics/{tenant_id}/{agent_id}/{metric_name}`.
4. Parsed messages are forwarded to the existing ingestion pipeline (reusing the same Redis job as HTTP ingestion).

## Tasks / Subtasks
- [ ] Task 1: Mosquitto Integration (AC: 1)
    - [ ] Create `docker/mosquitto/config/mosquitto.conf` with basic anonymous access and persistence enabled for PoC.
    - [ ] Create `docker/mosquitto/data` and `docker/mosquitto/log` directories.
    - [ ] Add `mosquitto` service to `docker-compose.yml` (ports 1883 for MQTT, 9001 for WebSockets).
    - [ ] Ensure `mosquitto` is on the `observability-network`.
- [ ] Task 2: MQTT Client Library Installation (AC: 2)
    - [ ] Install `php-mqtt/client` via composer in the `app` directory.
- [ ] Task 3: Implement MQTT Bridge Artisan Command (AC: 2, 3, 4)
    - [ ] Create `app/app/Console/Commands/MqttBridge.php`.
    - [ ] Implement `handle()` to connect to Mosquitto (host: `mosquitto`, port: 1883).
    - [ ] Subscribe to the wildcard topic `metrics/#`.
    - [ ] Implement topic parsing logic to extract `tenant_id`, `agent_id`, and `metric_name` from `metrics/{tenant_id}/{agent_id}/{metric_name}`.
    - [ ] Parse message payload (JSON) which should contain at least `value` and optionally `timestamp` and `dedupe_id`.
    - [ ] Find/Validate `Tenant` by `tenant_id` (UUID).
    - [ ] Dispatch `App\Jobs\ProcessMetricSubmission` with the validated tenant and formatted metric data.
    - [ ] Ensure robust error handling for malformed topics or payloads.
- [ ] Task 4: Bridge Service Management (AC: 2)
    - [ ] Document how to run the bridge command (e.g., `php artisan mqtt:bridge`).
    - [ ] Add the bridge command to the `dev` script in `app/composer.json` using `concurrently` for easy local development.
- [ ] Task 5: Verification & Testing (AC: 2, 3, 4)
    - [ ] Create a feature test `app/tests/Feature/MqttBridgeTest.php` that mocks the MQTT client and verifies the bridge dispatches the ingestion job.
    - [ ] Manually verify using `mosquitto_pub` from the host or another container.

## Dev Notes
- **Previous Story Insights**:
    - `ProcessMetricSubmission` job is the central ingestion point. It handles `Metric::upsert`/`insert` and publishes to Redis Pub/Sub for SSE. [Source: app/app/Jobs/ProcessMetricSubmission.php]
    - Metric ingestion expects a `tenant_id` which corresponds to the `id` (UUID) of the `Tenant` model. [Source: docs/architecture/4-data-models.md]
- **Tech Stack**:
    - **MQTT Broker**: Mosquitto 2.0. [Source: docs/architecture/3-tech-stack.md]
    - **Library**: `php-mqtt/client` is the standard PHP library for MQTT.
- **File Locations**:
    - Mosquitto Config: `docker/mosquitto/config/mosquitto.conf`
    - Artisan Command: `app/app/Console/Commands/MqttBridge.php`
    - Job: `app/app/Jobs/ProcessMetricSubmission.php`
- **Testing Requirements**:
    - Use `Tests\TestCase`.
    - Mock the MQTT client to avoid needing a live broker for automated feature tests.
- **Project Structure Notes**:
    - Infrastructure configs (like Mosquitto) live in `docker/`. [Source: docs/architecture/9-unified-project-structure.md]
    - Custom Artisan commands are located in `app/app/Console/Commands/`.

### Testing
- **Relevant Testing Standards**:
    - Test file location: `app/tests/Feature/`
    - Framework: PHPUnit (Laravel default).
    - Mocking: Use Mockery or Laravel's built-in mocking for Redis/Jobs.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-18 | 1.0 | Initial Story Draft | Bob (Scrum Master) |
| 2026-01-18 | 1.1 | Formatting Fixes | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
### Debug Log References
### Completion Notes List
### File List

## QA Results