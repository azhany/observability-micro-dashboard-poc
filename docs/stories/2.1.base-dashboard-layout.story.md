# Story 2.1: Base Dashboard Layout & Tenant View

## Status
Done

## Story
**As a** System Operator,
**I want** a modern, dark-mode dashboard interface,
**so that** I can view a high-level summary of my tenant's health.

## Acceptance Criteria
1. Vue 3 dashboard features a sidebar for navigation and a main content area for widgets.
2. An "Overview" page displays a list of active agents and their last reported status.
3. A "Tenant Detail" page exists that accepts a tenant ID and prepares placeholders for metric charts.
4. UI is styled using Tailwind CSS with a consistent "Technical/NOC" aesthetic.

## Tasks / Subtasks
- [x] Task 1: Frontend Setup & Layout (AC: 1, 4)
    - [x] Create `resources/js/Layouts/DashboardLayout.vue`.
    - [x] Implement Sidebar navigation (Home, Alerts, Settings). [Source: docs/front-end-spec.md#3-information-architecture-ia]
    - [x] Implement "NOC-First" Dark Mode styling (Bg: `#0B0E14`, Card: `#161B22`, Primary: `#00D1FF`). [Source: docs/front-end-spec.md#7-branding--style-guide]
    - [x] Ensure `tailwind.config.js` includes these custom colors.
- [x] Task 2: Dashboard Controller & Routes (AC: 2, 3)
    - [x] Create `App\Http\Controllers\DashboardController`.
    - [x] Define routes in `routes/web.php`:
        - `GET /dashboard` -> `index` (Overview).
        - `GET /dashboard/tenants/{tenant}` -> `show` (Detail).
    - [x] Apply `auth` and `verified` middleware (if applicable, or just `auth`).
- [x] Task 3: Overview Page Implementation (AC: 2, 4)
    - [x] Create `resources/js/Pages/Dashboard/Overview.vue`.
    - [x] In Controller `index` method: Fetch distinct `agent_id`s from `metrics_raw` table for the current tenant.
    - [x] Display agents in a grid/list with "Status" placeholders (e.g., "Online").
    - [x] Use `Link` component to navigate to Tenant Detail view.
- [x] Task 4: Tenant Detail Page Implementation (AC: 3, 4)
    - [x] Create `resources/js/Pages/Dashboard/TenantDetail.vue`.
    - [x] In Controller `show` method: Pass `tenant` and `agent_id` (if filtered) props.
    - [x] Add placeholder `div`s for Future Charts (CPU, Memory, Disk).
    - [x] Add "Live/Historical" toggle switch (UI only). [Source: docs/front-end-spec.md#key-screen-layouts-tenant-detail-view]
- [x] Task 5: Integration Testing (AC: 1, 2, 3)
    - [x] Create `tests/Feature/DashboardTest.php`.
    - [x] Test that `/dashboard` renders `Dashboard/Overview` component.
    - [x] Test that `/dashboard/tenants/{id}` renders `Dashboard/TenantDetail` component.
    - [x] Verify agent list data is passed to the view.

## Dev Notes
- **Project Structure:**
    - `resources/js/Layouts` directory needs to be created if it doesn't exist.
    - `resources/js/Pages/Dashboard` directory needs to be created.
- **Data Models:**
    - `Metric` model exists (`App\Models\Metric`). Use `Metric::where('tenant_id', $tenantId)->distinct()->pluck('agent_id')` to get agents.
    - **Note:** `tenant_id` in DB is Binary(16). Ensure the Controller handles the conversion or the Model casts it correctly when querying.
- **Styling:**
    - Use `lucide-vue-next` for icons if available, or heroicons (default in some Laravel kits). Preference: Lucide (per Spec).
    - Fonts: Inter and JetBrains Mono. Add to `resources/css/app.css` or `blade` layout.
- **Previous Story Insights:**
    - `metrics_raw` table is populated. We can seed some data or manually create metrics to verify the "Overview" list.

### Testing
- **Test File Location:** `tests/Feature/DashboardTest.php`
- **Test Standards:** Laravel Pest/PHPUnit (Inertia testing helpers).
- **Frameworks:** `Inertia::testing()`.
- **Specific Requirements:**
    - Verify component names.
    - Verify props (agents list, tenant details).
    - Ensure 200 OK response for auth users.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-18 | 1.0 | Initial Story Draft | Bob (Scrum Master) |
| 2026-01-18 | 1.1 | Applied QA fixes: auth middleware, updated tests | James (Developer) |

## Dev Agent Record
### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
None

### Completion Notes List
- All tasks completed successfully
- Installed lucide-vue-next for icon library
- Created DashboardLayout with sidebar navigation and NOC-style dark theme
- Implemented Overview page with agent listing and tenant info display
- Implemented TenantDetail page with placeholder chart areas and Live/Historical toggle
- Created comprehensive integration tests with 5 test cases, all passing
- Added HasFactory trait to Tenant and Metric models
- Created TenantFactory and MetricFactory for testing
- All tests passing (5/5 Dashboard tests, 34/34 total suite)
- Code linting passed with Pint
- **QA Fixes Applied (2026-01-18):**
  - Applied `auth` middleware to dashboard routes in `routes/web.php` (fixes TEST-001, Security NFR FAIL)
  - Updated all 5 dashboard tests to authenticate users with `actingAs()` before accessing protected routes
  - All tests passing (34/34 total suite)
  - Linting passed with 2 style issues auto-fixed

### File List
**Source Files (Created/Modified):**
- app/resources/js/Layouts/DashboardLayout.vue (created)
- app/resources/js/Pages/Dashboard/Overview.vue (created)
- app/resources/js/Pages/Dashboard/TenantDetail.vue (created)
- app/app/Http/Controllers/DashboardController.php (created)
- app/routes/web.php (modified - added dashboard routes, applied auth middleware)
- app/tailwind.config.js (modified - added NOC colors)
- app/resources/css/app.css (modified - added Google Fonts)
- app/app/Models/Tenant.php (modified - added HasFactory trait)
- app/app/Models/Metric.php (modified - added HasFactory trait)

**Test Files:**
- app/tests/Feature/DashboardTest.php (created, modified - added user authentication to all tests)
- app/database/factories/TenantFactory.php (created)
- app/database/factories/MetricFactory.php (created)

**Dependencies:**
- package.json (modified - added lucide-vue-next)

## QA Results

### Review Date: 2026-01-18 (Re-review)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
The developer has successfully addressed the critical security middleware gap identified in the previous review. The `auth` middleware is now correctly applied to the dashboard routes in `routes/web.php`, and the integration tests have been updated to reflect this requirement.

The performance concern regarding `metrics_raw` scaling remains but has been acknowledged as technical debt for the PoC phase.

### Compliance Check
- Coding Standards: [✓]
- Project Structure: [✓]
- Testing Strategy: [✓] (Tests updated to handle auth)
- All ACs Met: [✓]

### Improvements Checklist
- [x] Documented PERF-001 risk in controller (Previous review)
- [ ] Implement `agents` registry table (Deferred to future story)
- [x] Apply `auth` middleware to dashboard routes (Fixed)
- [ ] Implement Tenant Policy (Deferred to future story)

### Gate Status
Gate: CONCERNS → docs/qa/gates/2.1.base-dashboard-layout-dashboard-v2.yml
Risk profile: docs/qa/assessments/2.1.base-dashboard-layout-risk-20260118.md
NFR assessment: docs/qa/assessments/2.1.base-dashboard-layout-nfr-20260118.md

### Recommended Status
[✓ Ready for Done]
(Performance and Tenant Isolation risks are documented as known debt for PoC)