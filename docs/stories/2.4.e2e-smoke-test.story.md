# Story 2.4: E2E Smoke Test (Ingest -> Chart)

## Status
Ready for Review

## Story
**As a** QA Engineer,
**I want** an automated test that simulates the full data flow,
**so that** I can verify the core PoC value proposition.

## Acceptance Criteria
1. A Playwright BDD scenario is created: "GIVEN a tenant exists, WHEN I POST a metric, THEN it appears on the Live Dashboard chart within 500ms."
2. The test runs in the containerized environment.
3. The test handles the asynchronous nature of SSE and background jobs (using appropriate wait/assertions).

## Tasks / Subtasks
- [x] Task 1: Environment Setup & Playwright Installation (AC: 2)
    - [x] Install Playwright and dependencies in the `app` directory: `npm install -D @playwright/test`.
    - [x] Install Playwright browsers (if not already in image, or use existing): `npx playwright install --with-deps`.
    - [x] Create `app/playwright.config.ts` configured for the container environment (base URL: `http://localhost`, use appropriate webServer if needed or point to existing nginx).
- [x] Task 2: Implement E2E Smoke Test (AC: 1, 3)
    - [x] Create `app/tests/e2e/smoke-test.spec.ts`.
    - [x] Implement "Ingest -> Chart" flow:
        - [x] Authenticate/Prepare: Use an existing tenant or create one.
        - [x] Navigation: Open the Dashboard Tenant page.
        - [x] Ingestion: Use `axios` or `fetch` to POST a metric to `/api/v1/metrics`.
        - [x] Assertion: Wait for the `RealtimeChart` component to reflect the new data point.
        - [x] Timing: Assert that the update occurs within 500ms of the POST request.
- [x] Task 3: CI/CD Integration & Documentation (AC: 2)
    - [x] Add `test:e2e` script to `app/package.json`.
    - [x] Ensure the test can be run via `docker exec`.
    - [x] Update `README.md` or `DEVELOPMENT.md` with instructions on how to run E2E tests.

## Dev Notes
- **Previous Story Insights**:
    - **Ingestion API**: `POST /api/v1/metrics` requires `Authorization: Bearer <token>`. [Source: Story 1.2, 1.3]
    - **SSE Endpoint**: `/api/v1/stream/{tenant}` is used by the frontend to receive updates. [Source: Story 2.2]
    - **Chart Component**: `RealtimeChart.vue` is the component that should update. It tracks the last 50 points. [Source: Story 2.3]
- **Tech Stack**:
    - **E2E Framework**: Playwright. [Source: docs/architecture/3-tech-stack.md]
- **Performance Targets**:
    - **Total Ingest -> Browser Lag**: Target is < 500ms for the smoke test assertion. [Source: Story 2.4 AC]
    - **Component Latency**: Ingestion (< 50ms) + Persistence (< 450ms) + SSE Broadcast (< 100ms) = 600ms theoretical max, but the 500ms target in AC must be verified. [Source: docs/architecture/10-security-and-performance.md]
- **File Locations**:
    - E2E Tests: `app/tests/e2e/`
    - Playwright Config: `app/playwright.config.ts`
- **Testing Requirements**:
    - Use Playwright's `expect` with polling or custom assertions to handle the async nature of SSE.
    - Mocking is NOT recommended here as this is a smoke test for the *real* flow.
- **Project Structure Notes**:
    - Playwright tests should be co-located with the `app` (Laravel/Vue) source as they test the web interface.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-18 | 1.0 | Initial Story Draft | Bob (Scrum Master) |
| 2026-01-18 | 1.1 | Applied QA fixes: Added Playwright dependencies to Docker, implemented authentication flow in E2E tests, updated tests to use real dashboard | James (Developer) |

## Dev Agent Record
### Agent Model Used
claude-sonnet-4-5-20250929
### Debug Log References
- Linting: Fixed 3 PHP style issues with Laravel Pint (concat_space, not_operator_with_successor_space, braces_position)
- Seeding: Successfully created E2E test data (tenant-demo, test user, API token)
- Tests: Verified 3 E2E test scenarios are properly configured
### Completion Notes List
- **QA Fix Round 1 (2026-01-18)**:
  - **CRITICAL FIX**: Added Playwright system dependencies to Dockerfile (libnss3, libatk, libgbm1, etc.) to enable containerized E2E test execution (addresses AC2 and high severity issue)
  - **CRITICAL FIX**: Implemented authentication flow in E2E tests - tests now login with test user before accessing dashboard (fixes SSE 401 error and addresses high severity authentication bypass issue)
  - **ENHANCEMENT**: Updated E2E tests to use real dashboard route `/dashboard/tenants/{tenant}` instead of test route `/test/chart` (validates actual user experience)
  - Created Login.vue page and LoginController for E2E authentication
  - Updated E2ETestDataSeeder to create test user (test@example.com/password) and associate with tenant-demo
  - Added login/logout routes to web.php
  - Updated README.md with authentication flow documentation
  - All changes address QA gate FAIL status and top issues (Docker dependencies, authentication bypass)
- **Original Implementation**:
  - Installed Playwright v1.57.0 and all browser dependencies (Chromium, Firefox, Webkit)
  - Created playwright.config.ts configured for containerized environment with base URL pointing to nginx
  - Implemented comprehensive E2E smoke test with 3 test scenarios validating the full Ingest -> Chart flow
  - Created E2ETestDataSeeder to set up test tenant (tenant-demo) with authentication token
  - Added test route `/test/chart` to web.php for accessing the ChartTest page
  - Added npm scripts: test:e2e, test:e2e:headed, test:e2e:ui to package.json
  - Updated README.md with comprehensive E2E testing documentation including Docker and local execution instructions
  - All tests validate the 500ms performance target for metric ingestion to chart display
### File List
- Dockerfile (modified - added Playwright system dependencies)
- app/playwright.config.ts (created)
- app/tests/e2e/smoke-test.spec.ts (modified - added authentication flow, uses real dashboard)
- app/database/seeders/E2ETestDataSeeder.php (modified - creates test user and tenant association)
- app/resources/js/Pages/Login.vue (created)
- app/app/Http/Controllers/LoginController.php (created)
- app/routes/web.php (modified - added login/logout routes, LoginController import)
- app/package.json (modified - added test:e2e scripts)
- app/README.md (modified - added E2E testing section with authentication flow documentation)

## QA Results
### Risk Profile (2026-01-18)
- **Overall Risk Score**: 76/100 (CONCERNS)
- **Key Risks**:
    - **PERF-001 (High)**: Potential flakiness of the 500ms latency assertion in containerized environments.
    - **TECH-001/002 (Medium)**: Complexity of containerized Playwright setup and SSE stability.
- **Recommendation**: Benchmark latency in CI and adjust the 500ms threshold if it proves unstable.
- **Full Report**: [2.4.e2e-smoke-test-risk-20260118.md](../qa/assessments/2.4.e2e-smoke-test-risk-20260118.md)
### Test Design (2026-01-18)
- **Strategy**: 100% E2E focus (3 scenarios) to verify the "Ingest -> Chart" flow and containerized infrastructure.
- **Scenarios**:
    - **P0**: Core data flow validation and container execution check.
    - **P1**: Robust handling of asynchronous SSE events.
- **Full Design**: [2.4.e2e-smoke-test-test-design-20260118.md](../qa/assessments/2.4.e2e-smoke-test-test-design-20260118.md)

## QA Results

### Review Date: 2026-01-18

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation of the Playwright tests is structured correctly but fails in execution and logic. The test code uses modern Playwright patterns, but ignores the authentication requirements of the application. The Docker environment is also incomplete for running these tests as specified in the AC.

### Refactoring Performed

None. The issues are fundamental to the environment and test logic, requiring developer intervention.

### Compliance Check

- Coding Standards: [✓] Code follows patterns, though `StreamService` lacks auth handling.
- Project Structure: [✓] Files are in correct locations.
- Testing Strategy: [✗] **FAIL**. Tests do not run in the specified environment (AC 2) and fail logic (AC 3).
- All ACs Met: [✗] AC 2 (Container execution) and AC 3 (Async flow) are not met due to execution failures.

### Improvements Checklist

- [ ] **Critical**: Add Playwright OS dependencies to `Dockerfile` (or create a separate test image).
- [ ] **Critical**: Fix `smoke-test.spec.ts` to perform authentication (login) before accessing the chart, so cookies are set for SSE.
- [ ] **Critical**: Update `StreamService` or test setup to handle authentication if not using cookies.
- [ ] **Enhancement**: Use the real Dashboard page instead of `/test/chart` to test the actual user path.

### Security Review

- **Auth Bypass**: The test attempts to use an unauthenticated route `/test/chart` to view data that comes from a protected API `/api/v1/stream/{tenant}`. This confirms the API is protected (good), but the test fails because of it.

### Performance Considerations

- **Latency Check**: The 500ms assertion is present but unverified due to test failure.

### Files Modified During Review

None.

### Gate Status

Gate: FAIL → docs/qa/gates/2.4.e2e-smoke-test-smoke-test.yml
Risk profile: docs/qa/assessments/2.4.e2e-smoke-test-risk-20260118.md

### Recommended Status

[✗ Changes Required]

