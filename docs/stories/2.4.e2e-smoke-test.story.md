# Story 2.4: E2E Smoke Test (Ingest -> Chart)

## Status
Ready for Development

## Story
**As a** QA Engineer,
**I want** an automated test that simulates the full data flow,
**so that** I can verify the core PoC value proposition.

## Acceptance Criteria
1. A Playwright BDD scenario is created: "GIVEN a tenant exists, WHEN I POST a metric, THEN it appears on the Live Dashboard chart within 500ms."
2. The test runs in the containerized environment.
3. The test handles the asynchronous nature of SSE and background jobs (using appropriate wait/assertions).

## Tasks / Subtasks
- [ ] Task 1: Environment Setup & Playwright Installation (AC: 2)
    - [ ] Install Playwright and dependencies in the `app` directory: `npm install -D @playwright/test`.
    - [ ] Install Playwright browsers (if not already in image, or use existing): `npx playwright install --with-deps`.
    - [ ] Create `app/playwright.config.ts` configured for the container environment (base URL: `http://localhost`, use appropriate webServer if needed or point to existing nginx).
- [ ] Task 2: Implement E2E Smoke Test (AC: 1, 3)
    - [ ] Create `app/tests/e2e/smoke-test.spec.ts`.
    - [ ] Implement "Ingest -> Chart" flow:
        - [ ] Authenticate/Prepare: Use an existing tenant or create one.
        - [ ] Navigation: Open the Dashboard Tenant page.
        - [ ] Ingestion: Use `axios` or `fetch` to POST a metric to `/api/v1/metrics`.
        - [ ] Assertion: Wait for the `RealtimeChart` component to reflect the new data point.
        - [ ] Timing: Assert that the update occurs within 500ms of the POST request.
- [ ] Task 3: CI/CD Integration & Documentation (AC: 2)
    - [ ] Add `test:e2e` script to `app/package.json`.
    - [ ] Ensure the test can be run via `docker exec`.
    - [ ] Update `README.md` or `DEVELOPMENT.md` with instructions on how to run E2E tests.

## Dev Notes
- **Previous Story Insights**:
    - **Ingestion API**: `POST /api/v1/metrics` requires `Authorization: Bearer <token>`. [Source: Story 1.2, 1.3]
    - **SSE Endpoint**: `/api/v1/stream/{tenant}` is used by the frontend to receive updates. [Source: Story 2.2]
    - **Chart Component**: `RealtimeChart.vue` is the component that should update. It tracks the last 50 points. [Source: Story 2.3]
- **Tech Stack**:
    - **E2E Framework**: Playwright. [Source: docs/architecture/3-tech-stack.md]
- **Performance Targets**:
    - **Total Ingest -> Browser Lag**: Target is < 500ms for the smoke test assertion. [Source: Story 2.4 AC]
    - **Component Latency**: Ingestion (< 50ms) + Persistence (< 450ms) + SSE Broadcast (< 100ms) = 600ms theoretical max, but the 500ms target in AC must be verified. [Source: docs/architecture/10-security-and-performance.md]
- **File Locations**:
    - E2E Tests: `app/tests/e2e/`
    - Playwright Config: `app/playwright.config.ts`
- **Testing Requirements**:
    - Use Playwright's `expect` with polling or custom assertions to handle the async nature of SSE.
    - Mocking is NOT recommended here as this is a smoke test for the *real* flow.
- **Project Structure Notes**:
    - Playwright tests should be co-located with the `app` (Laravel/Vue) source as they test the web interface.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-18 | 1.0 | Initial Story Draft | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
### Debug Log References
### Completion Notes List
### File List

## QA Results
### Risk Profile (2026-01-18)
- **Overall Risk Score**: 76/100 (CONCERNS)
- **Key Risks**:
    - **PERF-001 (High)**: Potential flakiness of the 500ms latency assertion in containerized environments.
    - **TECH-001/002 (Medium)**: Complexity of containerized Playwright setup and SSE stability.
- **Recommendation**: Benchmark latency in CI and adjust the 500ms threshold if it proves unstable.
- **Full Report**: [2.4.e2e-smoke-test-risk-20260118.md](../qa/assessments/2.4.e2e-smoke-test-risk-20260118.md)
### Test Design (2026-01-18)
- **Strategy**: 100% E2E focus (3 scenarios) to validate the "Ingest -> Chart" flow and containerized infrastructure.
- **Scenarios**:
    - **P0**: Core data flow validation and container execution check.
    - **P1**: Robust handling of asynchronous SSE events.
- **Full Design**: [2.4.e2e-smoke-test-test-design-20260118.md](../qa/assessments/2.4.e2e-smoke-test-test-design-20260118.md)
