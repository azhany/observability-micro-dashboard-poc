# Story 4.3: Notification Dispatch (Webhook & Email)

## Status
Ready for Development

## Story
**As a** System Operator,
**I want** to receive notifications when an alert enters the `FIRING` state,
**so that** I can respond to issues immediately even when not looking at the dashboard.

## Acceptance Criteria
1. The system implements a notification dispatcher.
2. Webhook channel: Sends a POST request with alert details to a user-defined URL.
3. Email channel: Sends a basic alert email (can be simulated with Mailpit/Log for PoC).
4. Notifications are only sent on state transitions (e.g., only when an alert *starts* firing, not every time it is evaluated).

## Tasks / Subtasks
- [ ] **Notification Dispatcher Core** (AC: 1, 4)
    - [ ] Create a `NotifyTenant` Job or use Laravel's Notification system.
    - [ ] Implement logic to trigger notifications ONLY when `Alert` state changes to `FIRING`.
- [ ] **Webhook Channel Implementation** (AC: 2)
    - [ ] Implement `WebhookNotification` using Laravel's `Notification` or `Http` client.
    - [ ] Payload should include: Tenant Name, Metric Name, Value, Threshold, and Timestamp.
- [ ] **Email Channel Implementation** (AC: 3)
    - [ ] Create `AlertFiring` Mailable.
    - [ ] Configure `MAIL_MAILER=log` or `smtp` for Mailpit in `.env`.
- [ ] **Configuration for Notifications** (AC: 2, 3)
    - [ ] Add `notification_settings` (webhook URL, email address) to the `tenants` table or separate `tenant_settings` table. [Source: architecture/4-data-models.md#tenant]
- [ ] **Unit and Integration Testing**
    - [ ] Verify webhook is called with correct payload.
    - [ ] Verify email is sent on state transition.
    - [ ] Verify NO notification is sent if state is already `FIRING` and remains `FIRING`.

## Dev Notes
### Architecture References
- **Laravel Notifications**: Use the built-in system for extensibility. [Source: architecture/3-tech-stack.md]
- **Tenant Settings**: The `tenants` table includes a `settings` JSON field which can store notification preferences. [Source: architecture/4-data-models.md#tenant]

### File Locations
- Notifications: `app/app/Notifications/`
- Mailables: `app/app/Mail/`
- Jobs: `app/app/Jobs/`

### Testing
- Use `Notification::fake()` and `Http::fake()` to verify dispatch logic.
- Standard: Laravel built-in testing suite.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-18 | 0.1 | Initial draft for Epic 4 | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
<!-- {agent_model_name_version} -->

### Debug Log References
<!-- Reference any debug logs or traces generated during development -->

### Completion Notes List
<!-- Notes about the completion of tasks and any issues encountered -->

### File List
<!-- List all files created, modified, or affected during story implementation -->

## QA Results
<!-- Results from QA Agent QA review of the completed story implementation -->