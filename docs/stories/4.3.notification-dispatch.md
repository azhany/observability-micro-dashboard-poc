# Story 4.3: Notification Dispatch (Webhook & Email)

## Status
Done

## Story
**As a** System Operator,
**I want** to receive notifications when an alert enters the `FIRING` state,
**so that** I can respond to issues immediately even when not looking at the dashboard.

## Acceptance Criteria
1. The system implements a notification dispatcher.
2. Webhook channel: Sends a POST request with alert details to a user-defined URL.
3. Email channel: Sends a basic alert email (can be simulated with Mailpit/Log for PoC).
4. Notifications are only sent on state transitions (e.g., only when an alert *starts* firing, not every time it is evaluated).

## Tasks / Subtasks
- [x] **Notification Dispatcher Core** (AC: 1, 4)
    - [x] Create a `NotifyTenant` Job or use Laravel's Notification system.
    - [x] Implement logic to trigger notifications ONLY when `Alert` state changes to `FIRING`.
- [x] **Webhook Channel Implementation** (AC: 2)
    - [x] Implement `WebhookNotification` using Laravel's `Notification` or `Http` client.
    - [x] Payload should include: Tenant Name, Metric Name, Value, Threshold, and Timestamp.
- [x] **Email Channel Implementation** (AC: 3)
    - [x] Create `AlertFiring` Mailable.
    - [x] Configure `MAIL_MAILER=log` or `smtp` for Mailpit in `.env`.
- [x] **Configuration for Notifications** (AC: 2, 3)
    - [x] Add `notification_settings` (webhook URL, email address) to the `tenants` table or separate `tenant_settings` table. [Source: architecture/4-data-models.md#tenant]
- [x] **Unit and Integration Testing**
    - [x] Verify webhook is called with correct payload.
    - [x] Verify email is sent on state transition.
    - [x] Verify NO notification is sent if state is already `FIRING` and remains `FIRING`.

## Dev Notes
### Architecture References
- **Laravel Notifications**: Use the built-in system for extensibility. [Source: architecture/3-tech-stack.md]
- **Tenant Settings**: The `tenants` table includes a `settings` JSON field which can store notification preferences. [Source: architecture/4-data-models.md#tenant]

### File Locations
- Notifications: `app/app/Notifications/`
- Mailables: `app/app/Mail/`
- Jobs: `app/app/Jobs/`

### Testing
- Use `Notification::fake()` and `Http::fake()` to verify dispatch logic.
- Standard: Laravel built-in testing suite.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-18 | 0.1 | Initial draft for Epic 4 | Bob (Scrum Master) |
| 2026-01-19 | 1.0 | Implemented notification dispatch with webhook and email channels | James (Dev Agent) |

## Dev Agent Record
### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
None

### Completion Notes List
- Successfully implemented notification dispatch system using Laravel's built-in Notification framework
- Created AlertFiringNotification class that supports both webhook and email channels
- Implemented custom WebhookChannel for webhook notifications using Http facade
- Email notifications use Laravel's MailMessage for simplicity and built-in styling
- Notifications are triggered in EvaluateAlertRules job only when alert state transitions to FIRING
- Tenant notification preferences (webhook_url, notification_email) stored in existing settings JSON field
- Added routeNotificationForMail() method to Tenant model to route email notifications
- All 8 comprehensive tests passing, covering:
  - Webhook dispatch with correct payload
  - Email notification dispatch
  - No duplicate notifications when alert remains firing
  - No notifications for pending alerts
  - Webhook-only, email-only, and no-config scenarios
- Full test suite passes: 93 tests with 352 assertions

### File List
**Created:**
- app/app/Notifications/AlertFiringNotification.php
- app/app/Notifications/Channels/WebhookChannel.php
- app/app/Mail/AlertFiring.php (initially created, later replaced with MailMessage)
- app/resources/views/emails/alert-firing.blade.php (created but unused with MailMessage approach)
- app/tests/Feature/NotificationDispatchTest.php

**Modified:**
- app/app/Models/Tenant.php (added Notifiable trait and routeNotificationForMail method)
- app/app/Providers/AppServiceProvider.php (registered WebhookChannel)
- app/app/Jobs/EvaluateAlertRules.php (added notification dispatch on FIRING state transition)

## QA Results

### Review Date: 2026-01-19

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
The implementation of the notification dispatch system is robust and correctly leverages Laravel's Notification framework. The use of a custom `WebhookChannel` provides clear extensibility. The logic for ensuring notifications only trigger on `FIRING` state transitions is correctly implemented in the `EvaluateAlertRules` job.

### Refactoring Performed
- **File**: `app/app/Notifications/AlertFiringNotification.php`
  - **Change**: Implemented `ShouldQueue`.
  - **Why**: To ensure notifications are processed asynchronously.
  - **How**: Added `implements ShouldQueue` and removed inline `toWebhook` HTTP logic.
- **File**: `app/app/Notifications/Channels/WebhookChannel.php`
  - **Change**: Moved HTTP logic into the channel class.
  - **Why**: Follows Laravel's idiomatic pattern for custom channels and decouples the notification data from the transport.
- **File**: `app/app/Jobs/EvaluateAlertRules.php`
  - **Change**: Eager loaded `tenant` relationship.
  - **Why**: Avoid N+1 queries when evaluating multiple rules and dispatching notifications.

### Compliance Check
- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓
- All ACs Met: ✓

### Improvements Checklist
- [x] Refactored `AlertFiringNotification` to support queuing.
- [x] Decoupled `WebhookChannel` logic.
- [x] Optimized relationship loading in evaluation loop.
- [ ] Implement Webhook URL validation (SSRF protection) for production hardening.
- [ ] Add rate limiting for notifications to prevent alert storms.

### Security Review
The webhook feature introduces a potential SSRF risk as it makes requests to user-defined URLs. While acceptable for a PoC, production implementation must include a validation layer (e.g., using a package like `spatie/laravel-ssrf-protection` or custom IP blacklisting) to prevent internal network access.

### Performance Considerations
Notifications are now queued, significantly reducing the execution time of the `EvaluateAlertRules` job. Eager loading of the `tenant` relationship further optimizes the evaluation process.

### Files Modified During Review
- `app/app/Notifications/AlertFiringNotification.php`
- `app/app/Notifications/Channels/WebhookChannel.php`
- `app/app/Jobs/EvaluateAlertRules.php`

### Gate Status
Gate: PASS → docs/qa/gates/4.3.notification-dispatch-gate.yml

### Recommended Status
[✓ Ready for Done]