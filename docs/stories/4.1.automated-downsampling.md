# Story 4.1: Automated Downsampling (1m & 5m Rollups)

## Status
Done

## Story
**As a** System Operator,
**I want** raw metrics to be automatically summarized into 1-minute and 5-minute averages,
**so that** I can view long-term historical trends without loading millions of raw data points.

## Acceptance Criteria
1. Laravel Scheduler or a background worker runs every minute to calculate averages from `metrics_raw`.
2. Aggregated data is stored in `metrics_1m` and `metrics_5m` tables.
3. A retention policy is implemented (e.g., raw data deleted after 24h, 1m data after 7 days, 5m data after 30 days).
4. The API supports a `resolution` parameter to query these rollup tables.

## Tasks / Subtasks
- [x] **Database Migrations for Rollup Tables** (AC: 2)
    - [x] Create migration for `metrics_1m` [Source: architecture/7-database-schema.md#table-rollup]
    - [x] Create migration for `metrics_5m` (mirrors 1m structure)
- [x] **Aggregation Logic (Rollup Engine)** (AC: 1, 2)
    - [x] Implement `DownsampleMetrics` Laravel Job/Command.
    - [x] Logic to calculate average value per `tenant_id`, `metric_name`, and time window.
    - [x] Schedule 1m rollup to run every minute in `routes/console.php`.
    - [x] Schedule 5m rollup to run every 5 minutes.
- [x] **Retention Policy Implementation** (AC: 3)
    - [x] Create `CleanupOldMetrics` Command.
    - [x] Implement logic to delete data based on: `metrics_raw` > 24h, `metrics_1m` > 7d, `metrics_5m` > 30d.
    - [x] Schedule cleanup to run daily.
- [x] **API Enhancement for Historical Queries** (AC: 4)
    - [x] Update `MetricController` to accept `resolution` (raw, 1m, 5m).
    - [x] Update query logic to select from appropriate table based on `resolution`.
- [x] **Unit and Integration Testing**
    - [x] Test aggregation logic ensures correct averages are calculated.
    - [x] Test retention job deletes only the expected data. [Source: architecture/3-tech-stack.md#testing-strategy]

## Dev Notes
### Data Models
- **metrics_1m / metrics_5m**:
    - `id`: BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY
    - `tenant_id`: BINARY(16)
    - `metric_name`: VARCHAR(64)
    - `avg_value`: DOUBLE
    - `window_start`: TIMESTAMP
    - [Source: architecture/7-database-schema.md#table-rollup]

### File Locations
- Migrations: `app/database/migrations/`
- Rollup Jobs: `app/app/Jobs/` or `app/app/Console/Commands/`
- Controller: `app/app/Http/Controllers/Api/V1/MetricController.php`

### Testing
- Test file location: `app/tests/Feature/` and `app/tests/Unit/`
- Standards: Use Pest or PHPUnit as per project conventions. [Source: architecture/3-tech-stack.md]
- Testing frameworks and patterns: Laravel built-in testing suite.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-18 | 0.1 | Initial draft for Epic 4 | Bob (Scrum Master) |
| 2026-01-19 | 1.0 | Implementation complete - all tasks, tests passing, ready for review | James (Developer) |

## Dev Agent Record
### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
<!-- Reference any debug logs or traces generated during development -->

### Completion Notes List
- Successfully implemented all rollup tables (metrics_1m, metrics_5m) with proper indexes and foreign keys
- Created DownsampleMetrics command with optional --window-start parameter for testability
- Implemented CleanupOldMetrics command with proper retention policies (24h, 7d, 30d)
- Enhanced MetricController to support resolution parameter (raw, 1m, 5m) with proper tenant isolation
- All 24 tests passing (6 downsampling + 7 retention + 11 API tests)
- Commands scheduled appropriately: 1m rollup every minute, 5m rollup every 5 minutes, cleanup daily at 2 AM

### File List
**Created:**
- app/database/migrations/2026_01_18_231608_create_metrics_1m_table.php
- app/database/migrations/2026_01_18_231612_create_metrics_5m_table.php
- app/app/Console/Commands/DownsampleMetrics.php
- app/app/Console/Commands/CleanupOldMetrics.php
- app/app/Http/Controllers/Api/MetricController.php
- app/tests/Feature/MetricDownsamplingTest.php
- app/tests/Feature/MetricRetentionTest.php
- app/tests/Feature/MetricQueryApiTest.php

**Modified:**
- app/routes/console.php
- app/routes/api.php

## Definition of Done Checklist

### 1. Requirements Met: [x]
- [x] All functional requirements implemented:
  - Laravel scheduler runs every minute to calculate 1m averages from metrics_raw
  - Laravel scheduler runs every 5 minutes to calculate 5m averages
  - Aggregated data stored in metrics_1m and metrics_5m tables
  - Retention policy implemented (raw > 24h, 1m > 7d, 5m > 30d)
  - API supports resolution parameter (raw, 1m, 5m)
- [x] All acceptance criteria met (AC 1-4)

### 2. Coding Standards & Project Structure: [x]
- [x] Code follows Laravel best practices and conventions
- [x] File locations match project structure (migrations, commands, controllers, tests)
- [x] Security best practices applied (input validation, SQL injection prevention via query builder)
- [x] No linter errors or warnings (all fixed with Pint)
- [x] Code is well-commented for complex logic

### 3. Testing: [x]
- [x] 24 comprehensive tests implemented (6 downsampling + 7 retention + 11 API)
- [x] All tests pass successfully
- [x] Tests cover unit and integration scenarios
- [x] Edge cases tested (empty data, boundary conditions, multi-tenant isolation)

### 4. Functionality & Verification: [x]
- [x] Commands manually verified:
  - metrics:downsample 1m - successfully processes and aggregates
  - metrics:downsample 5m - successfully processes and aggregates
  - metrics:cleanup - successfully deletes old data
- [x] API endpoints verified with proper resolution parameter handling
- [x] Edge cases handled (empty tables, invalid resolutions, tenant isolation)

### 5. Story Administration: [x]
- [x] All tasks marked complete
- [x] File list updated with all created/modified files
- [x] Completion notes documented
- [x] Agent model and changelog updated

### 6. Dependencies, Build & Configuration: [x]
- [x] Project builds successfully
- [x] Linting passes (Pint)
- [x] No new dependencies added
- [x] Schedule configuration added to routes/console.php
- [x] No security vulnerabilities introduced

### 7. Documentation: [x]
- [x] Inline code documentation complete
- [x] Command descriptions clear
- [x] Test documentation comprehensive
- [x] Story file fully documented

### Final Confirmation: [x]
I confirm all applicable DoD items have been addressed. Story is ready for QA review.

## QA Results
<!-- Results from QA Agent QA review of the completed story implementation -->

### Review Date: 2026-01-19

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation is solid and follows Laravel best practices. The use of `updateOrInsert` for aggregations ensures idempotency, which is excellent for reliability. The `DownsampleMetrics` command includes a `--window-start` option, significantly improving testability. The API controller correctly handles tenant isolation and parameter validation.

### Compliance Check

- Coding Standards: [x] Follows PSR-12 and Laravel conventions.
- Project Structure: [x] Files are in correct locations.
- Testing Strategy: [x] comprehensive feature tests provided.
- All ACs Met: [x] All 4 ACs verified.

### Improvements Checklist

- [ ] (Recommendation) Consider adding a small delay (e.g., 30s) or processing the *previous* window relative to "now - 1 minute" in `DownsampleMetrics` to account for potential ingestion latency/clock skew, ensuring all data for a window has arrived before aggregation. Currently, it processes up to the current second if scheduled exactly on the minute.
- [ ] (Recommendation) For `CleanupOldMetrics`, consider chunking deletes (e.g., `limit(1000)`) in a loop to avoid potential table locks if `metrics_raw` becomes massive.

### Security Review

- Tenant isolation is correctly enforced in `MetricController` via `where('tenant_id', $tenant->id)`.
- Input validation prevents SQL injection and invalid parameters.

### Files Modified During Review

None.

### Gate Status

Gate: PASS → docs/qa/gates/4.1.automated-downsampling.yml

### Recommended Status

[✓ Ready for Done]