# Story 4.1: Automated Downsampling (1m & 5m Rollups)

## Status
Ready for Development

## Story
**As a** System Operator,
**I want** raw metrics to be automatically summarized into 1-minute and 5-minute averages,
**so that** I can view long-term historical trends without loading millions of raw data points.

## Acceptance Criteria
1. Laravel Scheduler or a background worker runs every minute to calculate averages from `metrics_raw`.
2. Aggregated data is stored in `metrics_1m` and `metrics_5m` tables.
3. A retention policy is implemented (e.g., raw data deleted after 24h, 1m data after 7 days, 5m data after 30 days).
4. The API supports a `resolution` parameter to query these rollup tables.

## Tasks / Subtasks
- [ ] **Database Migrations for Rollup Tables** (AC: 2)
    - [ ] Create migration for `metrics_1m` [Source: architecture/7-database-schema.md#table-rollup]
    - [ ] Create migration for `metrics_5m` (mirrors 1m structure)
- [ ] **Aggregation Logic (Rollup Engine)** (AC: 1, 2)
    - [ ] Implement `DownsampleMetrics` Laravel Job/Command.
    - [ ] Logic to calculate average value per `tenant_id`, `metric_name`, and time window.
    - [ ] Schedule 1m rollup to run every minute in `routes/console.php`.
    - [ ] Schedule 5m rollup to run every 5 minutes.
- [ ] **Retention Policy Implementation** (AC: 3)
    - [ ] Create `CleanupOldMetrics` Command.
    - [ ] Implement logic to delete data based on: `metrics_raw` > 24h, `metrics_1m` > 7d, `metrics_5m` > 30d.
    - [ ] Schedule cleanup to run daily.
- [ ] **API Enhancement for Historical Queries** (AC: 4)
    - [ ] Update `MetricController` to accept `resolution` (raw, 1m, 5m).
    - [ ] Update query logic to select from appropriate table based on `resolution`.
- [ ] **Unit and Integration Testing**
    - [ ] Test aggregation logic ensures correct averages are calculated.
    - [ ] Test retention job deletes only the expected data. [Source: architecture/3-tech-stack.md#testing-strategy]

## Dev Notes
### Data Models
- **metrics_1m / metrics_5m**:
    - `id`: BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY
    - `tenant_id`: BINARY(16)
    - `metric_name`: VARCHAR(64)
    - `avg_value`: DOUBLE
    - `window_start`: TIMESTAMP
    - [Source: architecture/7-database-schema.md#table-rollup]

### File Locations
- Migrations: `app/database/migrations/`
- Rollup Jobs: `app/app/Jobs/` or `app/app/Console/Commands/`
- Controller: `app/app/Http/Controllers/Api/V1/MetricController.php`

### Testing
- Test file location: `app/tests/Feature/` and `app/tests/Unit/`
- Standards: Use Pest or PHPUnit as per project conventions. [Source: architecture/3-tech-stack.md]
- Testing frameworks and patterns: Laravel built-in testing suite.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-18 | 0.1 | Initial draft for Epic 4 | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
<!-- {agent_model_name_version} -->

### Debug Log References
<!-- Reference any debug logs or traces generated during development -->

### Completion Notes List
<!-- Notes about the completion of tasks and any issues encountered -->

### File List
<!-- List all files created, modified, or affected during story implementation -->

## QA Results
<!-- Results from QA Agent QA review of the completed story implementation -->