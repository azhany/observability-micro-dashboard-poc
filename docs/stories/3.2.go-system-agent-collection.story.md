# Story 3.2: Go System Agent - Metric Collection

## Status
Ready for Review (QA Fixes Applied)

## Story
**As a** System Operator,
**I want** a lightweight binary that collects system stats (CPU, Memory, Disk),
**so that** I don't have to write custom scripts for basic server monitoring.

## Acceptance Criteria
1. Go 1.2x project initialized in the monorepo (e.g., `/agent`).
2. Agent successfully collects CPU percentage, Memory usage (bytes), and Disk usage (percentage).
3. Collection interval is configurable via environment variables or a config file.
4. The agent outputs metrics to stdout for local debugging.

## Tasks / Subtasks
- [x] Task 1: Initialize Go Project (AC: 1)
    - [x] Create directory structure: `agent/cmd/agent`, `agent/internal/collector`, `agent/internal/models`.
    - [x] Initialize go module: `cd agent && go mod init observability-agent`.
    - [x] Install dependencies: `go get github.com/shirou/gopsutil/v3` (or latest).
- [x] Task 2: Define Metric Models (AC: 2)
    - [x] Create `agent/internal/models/metric.go` to define the struct for metric data (tenant_id, agent_id, metric_name, value, timestamp).
- [x] Task 3: Implement Collectors (AC: 2)
    - [x] Create `agent/internal/collector/cpu.go` using `gopsutil/cpu`.
    - [x] Create `agent/internal/collector/memory.go` using `gopsutil/mem`.
    - [x] Create `agent/internal/collector/disk.go` using `gopsutil/disk`.
    - [x] Ensure all collectors return data in a standard format (value, error).
- [x] Task 4: Main Loop & Configuration (AC: 3, 4)
    - [x] Create `agent/cmd/agent/main.go`.
    - [x] Implement configuration loading (ENV variables: `COLLECTION_INTERVAL`, `AGENT_ID`, `TENANT_ID`). Default interval: 5s.
    - [x] Create a ticker loop that runs every `COLLECTION_INTERVAL`.
    - [x] Gather metrics from all collectors.
    - [x] Print metrics to stdout in JSON format (preparing for MQTT later).
- [x] Task 5: Testing & Verification
    - [x] Write unit tests for collectors in `agent/internal/collector/` (mocking `gopsutil` if feasible, or just validating non-zero values on dev machine).
    - [x] Build the binary: `cd agent && go build -o bin/agent cmd/agent/main.go`.
    - [x] Run the binary and verify stdout output.

## Dev Notes
- **Tech Stack**:
    - **Language**: Go 1.2x [Source: docs/architecture/3-tech-stack.md]
    - **Library**: `gopsutil` is suggested for metrics [Source: docs/architecture/8-go-agent-structure.md].
- **Project Structure**:
    - Entry point: `agent/cmd/agent/main.go` [Source: docs/architecture/9-unified-project-structure.md]
    - Internal logic: `agent/internal/collector/` and `agent/internal/models/` [Source: docs/architecture/8-go-agent-structure.md]
    - *Note*: There is a slight discrepancy in docs between `agent/main.go` and `agent/cmd/agent/main.go`. We are using `agent/cmd/agent/main.go` to align with the Unified Project Structure.
- **Data Models**:
    - `Metric` struct should likely align with the JSON structure expected by the backend: `metric_name`, `value`, `timestamp`, `agent_id`. [Source: docs/architecture/5-api-specification-rest-ingestion.md]
- **Configuration**:
    - Use standard `os.Getenv` or a lightweight config library if preferred, but keep it simple as per "Lightweight binary" goal.

### Testing
- Standard Go testing (`go test ./...`).
- Focus on ensuring collectors don't panic and return reasonable values.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-18 | 1.0 | Initial Story Draft | Bob (Scrum Master) |
| 2026-01-18 | 1.1 | Implementation Complete - All tasks completed, tests passing | James (Developer) |
| 2026-01-18 | 1.2 | QA Fixes Applied - Fixed CPU blocking (PERF-001), implemented warm-up cycle, validated JSON schema | James (Developer) |

## Dev Agent Record
### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
**QA Fixes - 2026-01-18:**
- go test observability-agent/internal/... -v: ✓ All tests pass (5 tests in 1.343s)
- CPU test now completes in 0.00s (was 1.00s) - blocking issue fixed
- Verified 2-second collection interval: exact timing with no drift
- First CPU collection after warm-up: 15.97% (not 0%) - warm-up successful

### Completion Notes List
- Successfully initialized Go project with module name `observability-agent`
- Installed gopsutil v4.25.12 for system metrics collection
- Implemented three collectors (CPU, Memory, Disk) using gopsutil library
- CPU collector uses non-blocking approach (cpu.Percent with 0 interval)
- Memory collector reports used memory in bytes
- Disk collector reports usage percentage for root partition
- Created Metric model with fields: tenant_id, agent_id, metric_name, value, timestamp
- Main loop implements configurable collection interval via ENV variables
- Default configuration: 5s interval, tenant-default, agent-default
- Configuration supports: COLLECTION_INTERVAL, TENANT_ID, AGENT_ID
- Metrics output as individual JSON objects to stdout
- All unit tests pass successfully
- Binary builds successfully (3.1MB) and runs with correct output
- Verified configuration works with custom environment variables
- Verified collection interval timing with 2-second interval test

**QA Fixes Applied (2026-01-18):**
- Fixed PERF-001: CPU collection no longer blocks - changed from 1-second blocking call to non-blocking state-based measurement
- Implemented warm-up cycle: CPU collector initialized before first metric broadcast to avoid 0% readings
- Added JSON schema validation tests to ensure backend compatibility
- Verified all metric names within 64-character limit (cpu.usage.percent: 17 chars, memory.used.bytes: 17 chars, disk.usage.percent: 18 chars)
- Validated JSON structure matches backend requirements (metric_name, value, timestamp, agent_id all present and correctly typed)
- Verified timing accuracy: 2-second interval shows exact 2-second spacing with no drift
- All 5 tests pass (3 collector tests + 2 schema validation tests)

### File List
- agent/go.mod (Created - Go module definition)
- agent/go.sum (Created - Go module dependencies)
- agent/cmd/agent/main.go (Modified - Added CPU warm-up cycle before collection loop)
- agent/internal/models/metric.go (Created - Metric data model)
- agent/internal/models/metric_test.go (Created - JSON schema validation tests)
- agent/internal/collector/cpu.go (Modified - Changed to non-blocking CPU collection)
- agent/internal/collector/memory.go (Created - Memory collector)
- agent/internal/collector/disk.go (Created - Disk collector)
- agent/internal/collector/cpu_test.go (Created - CPU collector tests)
- agent/internal/collector/memory_test.go (Created - Memory collector tests)
- agent/internal/collector/disk_test.go (Created - Disk collector tests)
- agent/bin/agent (Generated - Compiled binary)

## QA Results



### Review Date: 2026-01-18



### Reviewed By: Quinn (Test Architect)



### Code Quality Assessment

The implementation is solid and fulfills all Acceptance Criteria. The Go project structure is clean, although it uses `internal/` instead of `pkg/` as suggested in the architecture docs (minor deviation). The main loop correctly handles intervals and configuration via environment variables.



### Refactoring Performed

No direct refactoring performed to avoid disrupting the developer's environment, but identified a critical improvement for `CollectCPU`.



### Compliance Check

- Coding Standards: [✓]

- Project Structure: [CONCERNS] (Uses `internal/` instead of `pkg/` as per Unified Project Structure)

- Testing Strategy: [✓]

- All ACs Met: [✓]



### Improvements Checklist

- [x] Verified collectors return valid data types.

- [x] Confirmed JSON output format matches model definition.

- [ ] **Must Fix**: CPU collection blocks for 1 second. This will cause drift if the collection interval is small (e.g., 2s interval becomes 3s effectively). Recommend using a non-blocking approach with state tracking.

- [ ] **Recommendation**: Move `internal/collector` to `pkg/collector` if it's intended to be shared, or stay in `internal` if it's private to this agent. Architecture docs suggested `pkg/`.

- [ ] **Recommendation**: Implement a "warm-up" call for CPU during agent startup to avoid 0% on the first broadcast.



### Security Review

- Agent runs with standard privileges.

- No sensitive data exposed in logs or stdout beyond metrics.

- Environment variables are used for configuration, which is standard.



### Performance Considerations

- The binary size is excellent (~3MB).

- Blocking CPU collection is the primary performance bottleneck identified.



### Gate Status

Gate: CONCERNS → docs/qa/gates/3.2-go-system-agent-collection.yml

Risk profile: docs/qa/assessments/3.2-risk-20260118.md

Test design: docs/qa/assessments/3.2-test-design-20260118.md



### Recommended Status

[✓ Ready for Done] (Conditional on addressing the CPU blocking issue in a follow-up story or task if high-frequency monitoring is required).
