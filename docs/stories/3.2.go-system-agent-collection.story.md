# Story 3.2: Go System Agent - Metric Collection

## Status
Ready for Development

## Story
**As a** System Operator,
**I want** a lightweight binary that collects system stats (CPU, Memory, Disk),
**so that** I don't have to write custom scripts for basic server monitoring.

## Acceptance Criteria
1. Go 1.2x project initialized in the monorepo (e.g., `/agent`).
2. Agent successfully collects CPU percentage, Memory usage (bytes), and Disk usage (percentage).
3. Collection interval is configurable via environment variables or a config file.
4. The agent outputs metrics to stdout for local debugging.

## Tasks / Subtasks
- [ ] Task 1: Initialize Go Project (AC: 1)
    - [ ] Create directory structure: `agent/cmd/agent`, `agent/internal/collector`, `agent/internal/models`.
    - [ ] Initialize go module: `cd agent && go mod init observability-agent`.
    - [ ] Install dependencies: `go get github.com/shirou/gopsutil/v3` (or latest).
- [ ] Task 2: Define Metric Models (AC: 2)
    - [ ] Create `agent/internal/models/metric.go` to define the struct for metric data (tenant_id, agent_id, metric_name, value, timestamp).
- [ ] Task 3: Implement Collectors (AC: 2)
    - [ ] Create `agent/internal/collector/cpu.go` using `gopsutil/cpu`.
    - [ ] Create `agent/internal/collector/memory.go` using `gopsutil/mem`.
    - [ ] Create `agent/internal/collector/disk.go` using `gopsutil/disk`.
    - [ ] Ensure all collectors return data in a standard format (value, error).
- [ ] Task 4: Main Loop & Configuration (AC: 3, 4)
    - [ ] Create `agent/cmd/agent/main.go`.
    - [ ] Implement configuration loading (ENV variables: `COLLECTION_INTERVAL`, `AGENT_ID`, `TENANT_ID`). Default interval: 5s.
    - [ ] Create a ticker loop that runs every `COLLECTION_INTERVAL`.
    - [ ] Gather metrics from all collectors.
    - [ ] Print metrics to stdout in JSON format (preparing for MQTT later).
- [ ] Task 5: Testing & Verification
    - [ ] Write unit tests for collectors in `agent/internal/collector/` (mocking `gopsutil` if feasible, or just validating non-zero values on dev machine).
    - [ ] Build the binary: `cd agent && go build -o bin/agent cmd/agent/main.go`.
    - [ ] Run the binary and verify stdout output.

## Dev Notes
- **Tech Stack**:
    - **Language**: Go 1.2x [Source: docs/architecture/3-tech-stack.md]
    - **Library**: `gopsutil` is suggested for metrics [Source: docs/architecture/8-go-agent-structure.md].
- **Project Structure**:
    - Entry point: `agent/cmd/agent/main.go` [Source: docs/architecture/9-unified-project-structure.md]
    - Internal logic: `agent/internal/collector/` and `agent/internal/models/` [Source: docs/architecture/8-go-agent-structure.md]
    - *Note*: There is a slight discrepancy in docs between `agent/main.go` and `agent/cmd/agent/main.go`. We are using `agent/cmd/agent/main.go` to align with the Unified Project Structure.
- **Data Models**:
    - `Metric` struct should likely align with the JSON structure expected by the backend: `metric_name`, `value`, `timestamp`, `agent_id`. [Source: docs/architecture/5-api-specification-rest-ingestion.md]
- **Configuration**:
    - Use standard `os.Getenv` or a lightweight config library if preferred, but keep it simple as per "Lightweight binary" goal.

### Testing
- Standard Go testing (`go test ./...`).
- Focus on ensuring collectors don't panic and return reasonable values.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-18 | 1.0 | Initial Story Draft | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results