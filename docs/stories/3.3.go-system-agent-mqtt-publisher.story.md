# Story 3.3: Go System Agent - MQTT Publisher

## Status
Ready for Review

## Story
**As a** System Operator,
**I want** the Go agent to push its collected metrics to the MQTT broker,
**so that** they can be visualized on the dashboard.

## Acceptance Criteria
1. Go agent implements an MQTT client that connects to the Mosquitto broker.
2. Agent publishes metrics using the required topic structure: `metrics/{tenant_id}/{agent_id}/{metric_name}`.
3. Agent handles connection retries gracefully.
4. Agent includes an `agent_id` and `timestamp` in every published payload.
5. Configuration supports MQTT broker address, port, username, and password via environment variables.

## Tasks / Subtasks
- [x] Task 1 (AC: 1)
    - [x] Create directory `agent/internal/publisher`.
    - [x] Install Paho MQTT library: `go get github.com/eclipse/paho.mqtt.golang`.
    - [x] Implement `publisher.go` with a client wrapper that handles connection and publishing. [Source: docs/architecture/8-go-agent-structure.md]
- [x] Task 2 (AC: 1, 3, 5)
    - [x] Update configuration in `agent/cmd/agent/main.go` to include MQTT settings (MQTT_BROKER, MQTT_PORT, MQTT_USER, MQTT_PASS).
    - [x] Implement robust connection logic with retries if the broker is unavailable.
- [x] Task 3 (AC: 2, 4)
    - [x] Modify `agent/cmd/agent/main.go` to initialize the publisher.
    - [x] Update `collectAndPrint` (or rename to `collectAndPublish`) to send metrics via MQTT instead of (or in addition to) stdout.
    - [x] Ensure topic format matches: `metrics/{tenant_id}/{agent_id}/{metric_name}`. [Source: docs/MQTT_BRIDGE.md]
- [x] Task 4 (AC: 1, 2, 3, 4)
    - [x] Write unit tests for the publisher (mocking the MQTT client if possible).
    - [x] Verify message delivery using `mosquitto_sub` or by checking the MQTT Bridge logs in the Laravel app.
    - [x] Verify that metrics appear in the database/dashboard if the bridge is running.

## Dev Notes
- **MQTT Topic Structure**: `metrics/{tenant_id}/{agent_id}/{metric_name}` [Source: docs/MQTT_BRIDGE.md]
- **MQTT Payload**: Must be JSON. The `Metric` model in `agent/internal/models/metric.go` already includes `value`, `timestamp`, `agent_id`, and `tenant_id`. [Source: docs/MQTT_BRIDGE.md]
- **Default Credentials**: For development, use `bridge_user` / `bridge_pass`. [Source: docs/MQTT_BRIDGE.md]
- **Broker Host**: Use `localhost` for local development outside containers, or `mosquitto` if running inside the docker network.
- **Previous Story Insights**:
    - The CPU collector requires a warm-up call before the main loop starts to ensure non-zero readings. [Source: docs/stories/3.2.go-system-agent-collection.story.md]
    - Metric model is already established and supports JSON marshaling. [Source: agent/internal/models/metric.go]

### Testing
- **Test File Location**: `agent/internal/publisher/publisher_test.go`
- **Test Standards**: Standard Go testing library (`testing`).
- **Testing Frameworks**: Use `paho.mqtt.golang` mocking or integration testing with a local Mosquitto.
- **Verification**: Use `mosquitto_sub -h localhost -p 1883 -u bridge_user -P bridge_pass -t "metrics/#" -v` to verify delivery.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-18 | 1.0 | Initial Story Draft | Bob (Scrum Master) |
| 2026-01-18 | 1.1 | Story Implementation Complete | James (Developer) |

## Dev Agent Record
### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
- Mosquitto broker configuration issue encountered during testing: `protocol_version` directive not supported in Mosquitto 2.0+. Removed from config.
- Docker volume mount issue with passwd file prevented initial testing with authentication. Tested with anonymous access enabled temporarily.

### Completion Notes List
- Successfully implemented MQTT publisher with Paho MQTT library v1.5.1
- Publisher includes auto-reconnect logic with exponential backoff (5s to 60s intervals)
- QoS 1 (at least once delivery) implemented for reliable message delivery
- Verified MQTT publishing via Mosquitto broker logs showing PUBLISH/PUBACK handshakes
- Topic structure confirmed: `metrics/{tenant_id}/{agent_id}/{metric_name}`
- All unit tests pass; integration tests skipped (require running broker)
- Agent maintains backward compatibility by logging metrics to stdout in addition to MQTT publishing

### File List
**New Files:**
- `agent/internal/publisher/publisher.go` - MQTT publisher implementation
- `agent/internal/publisher/publisher_test.go` - Publisher unit tests

**Modified Files:**
- `agent/cmd/agent/main.go` - Added MQTT configuration, publisher initialization, and renamed `collectAndPrint` to `collectAndPublish`
- `agent/go.mod` - Added Paho MQTT dependencies
- `agent/go.sum` - Updated checksums for new dependencies

**Infrastructure Files (Fixed):**
- `docker/mosquitto/config/mosquitto.conf` - Removed unsupported `protocol_version` directive

## QA Results
(To be filled by QA Agent)