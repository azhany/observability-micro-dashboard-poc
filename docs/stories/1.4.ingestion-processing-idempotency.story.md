# Story 1.4: Ingestion Processing & Idempotency

## Status
Ready for Development

## Story
**As a** System Operator,
**I want** metrics to be processed asynchronously and deduplicated,
**so that** the API remains fast and data remains consistent despite network retries.

## Acceptance Criteria
1. Ingested metrics are dispatched to a Redis-backed Laravel Job.
2. Job worker persists metrics to the `metrics_raw` table in MariaDB.
3. The system uses a `dedupe_id` (if provided in payload) to prevent duplicate entries for the same event.
4. Failed jobs are automatically retried with exponential backoff.

## Tasks / Subtasks
- [ ] Task 1: Database Migration for Metrics (AC: 2, 3)
    - [ ] Create migration for `metrics_raw` table.
    - [ ] Columns: `id` (BIGINT PK), `tenant_id` (BINARY(16)), `agent_id` (VARCHAR(64)), `metric_name` (VARCHAR(64)), `value` (DOUBLE(16,4)), `timestamp` (TIMESTAMP(6)), `dedupe_id` (VARCHAR(128) UNIQUE). [Source: architecture/7-database-schema.md]
    - [ ] Add index `idx_tenant_metric_time` on (`tenant_id`, `metric_name`, `timestamp` DESC). [Source: architecture/7-database-schema.md]
- [ ] Task 2: Metric Model & Repository (AC: 2, 3)
    - [ ] Create `App\Models\Metric` model.
    - [ ] Configure `$fillable` for all fields.
    - [ ] Ensure `timestamp` is cast correctly for high-precision.
- [ ] Task 3: Job Implementation - `ProcessMetricSubmission` (AC: 1, 2, 3, 4)
    - [ ] Update `App\Jobs\ProcessMetricSubmission` to implement `ShouldQueue`.
    - [ ] Configure `public $tries = 5;` and `public $backoff = [10, 30, 60];`. [Source: Epic 1.4 AC 4]
    - [ ] Implement `handle()` logic:
        - Use database transaction for atomicity.
        - Iterate through the metrics array.
        - Use `upsert` or `firstOrCreate` with `dedupe_id` if present. [Source: architecture/4-data-models.md]
        - If `dedupe_id` is null, always insert.
        - Associate with `tenant_id` from the job context.
- [ ] Task 4: Integration Testing (AC: 1, 2, 3, 4)
    - [ ] Create `tests/Feature/MetricProcessingTest.php`.
    - [ ] Test cases:
        - [ ] Verify single metric persistence to `metrics_raw`.
        - [ ] Verify bulk metric persistence (multi-row insert).
        - [ ] Verify idempotency: pushing same `dedupe_id` twice results in only one DB record.
        - [ ] Verify job retries on DB failure (can use `Queue::fake()` or mock DB).
        - [ ] Verify `tenant_id` is correctly stored in binary format.

## Dev Notes
- **Previous Story Insights:**
    - `ProcessMetricSubmission` job already exists as a placeholder and is dispatched by `MetricIngestionController`.
    - The payload is already normalized to an array in the controller.
    - Max bulk size is 1000 items, so `upsert` is safe and efficient.
- **Data Models:**
    - `metrics_raw` uses `BINARY(16)` for `tenant_id`. Ensure the `Metric` model handles UUID to Binary conversion (or use a trait if existing). [Source: architecture/7-database-schema.md]
    - `dedupe_id` is unique. Use `INSERT IGNORE` or Laravel's `upsert` to handle collisions gracefully. [Source: architecture/4-data-models.md]
- **File Locations:**
    - Migration: `database/migrations/YYYY_MM_DD_HHMMSS_create_metrics_raw_table.php`
    - Model: `app/Models/Metric.php`
    - Job: `app/Jobs/ProcessMetricSubmission.php`
    - Test: `tests/Feature/MetricProcessingTest.php`
- **Testing Requirements:**
    - Use `RefreshDatabase` trait.
    - Ensure `dedupe_id` logic is tested thoroughly.
    - Test that `timestamp` precision is maintained.

### Testing
- **Test File Location:** `tests/Feature/MetricProcessingTest.php`
- **Test Standards:** Laravel Pest/PHPUnit.
- **Frameworks:** PHPUnit, Laravel Testing utilities.
- **Specific Requirements:**
    - Must verify data in `metrics_raw` after job execution.
    - Must verify that `dedupe_id` prevents duplicate records.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-18 | 1.0 | Initial Story Draft | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

## QA Results
