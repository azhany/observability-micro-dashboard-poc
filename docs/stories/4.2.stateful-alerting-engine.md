# Story 4.2: Stateful Alerting Engine (Rule Evaluator)

## Status
Ready for Development

## Story
**As a** System Operator,
**I want** to define thresholds (e.g., CPU > 90%) that trigger alerts,
**so that** I am informed of system issues automatically.

## Acceptance Criteria
1. Database schema for `alert_rules` (metric_name, operator, threshold, duration, tenant_id).
2. An evaluator job runs periodically (e.g., every 30s) to check rules against recent metrics.
3. Alerts are stateful: they transition from `OK` -> `PENDING` -> `FIRING` based on the rule's duration.
4. An `alerts` table tracks the history of these state transitions.

## Tasks / Subtasks
- [ ] **Database Migrations for Alerting** (AC: 1, 4)
    - [ ] Create `alert_rules` table. [Source: architecture/4-data-models.md#alertrule]
    - [ ] Create `alerts` table (tracks current state and history).
- [ ] **Alert Rule Management API/UI Placeholder** (AC: 1)
    - [ ] Create Model and basic CRUD logic for `AlertRule`.
- [ ] **Alert Evaluator Engine** (AC: 2, 3)
    - [ ] Create `EvaluateAlertRules` Job/Command.
    - [ ] Logic to query `alert_rules` and check against recent `metrics_raw` data.
    - [ ] Implement state machine logic:
        - `OK` -> `PENDING`: If threshold breached but `duration` not yet met.
        - `PENDING` -> `FIRING`: If threshold remains breached for `duration`.
        - `FIRING`/`PENDING` -> `OK`: If threshold no longer breached.
    - [ ] Record state changes in the `alerts` table.
- [ ] **Scheduling** (AC: 2)
    - [ ] Schedule evaluation to run every 30-60 seconds in `routes/console.php`.
- [ ] **Unit and Integration Testing**
    - [ ] Test state transition logic (OK -> PENDING -> FIRING).
    - [ ] Test that alerts are correctly isolated by `tenant_id`.

## Dev Notes
### Data Models
- **AlertRule**:
    - `id`: UUID
    - `tenant_id`: UUID
    - `metric_name`: String
    - `operator`: Enum (>, <, =, >=, <=)
    - `threshold`: Double
    - `duration`: Integer (Seconds condition must persist)
    - [Source: architecture/4-data-models.md#alertrule]
- **Alert** (Suggested Schema):
    - `id`: UUID
    - `tenant_id`: UUID
    - `alert_rule_id`: UUID
    - `state`: Enum (OK, PENDING, FIRING)
    - `started_at`: Timestamp
    - `last_checked_at`: Timestamp

### File Locations
- Migrations: `app/database/migrations/`
- Alert Evaluator: `app/app/Jobs/EvaluateAlertRules.php`
- Models: `app/app/Models/AlertRule.php`, `app/app/Models/Alert.php`

### Testing
- Ensure evaluation logic handles high-volume metric data efficiently. [Source: architecture/10-security-and-performance.md]
- Standard: Use Laravel's built-in testing suite.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-18 | 0.1 | Initial draft for Epic 4 | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
<!-- {agent_model_name_version} -->

### Debug Log References
<!-- Reference any debug logs or traces generated during development -->

### Completion Notes List
<!-- Notes about the completion of tasks and any issues encountered -->

### File List
<!-- List all files created, modified, or affected during story implementation -->

## QA Results
<!-- Results from QA Agent QA review of the completed story implementation -->