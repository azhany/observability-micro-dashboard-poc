# Story 4.2: Stateful Alerting Engine (Rule Evaluator)

## Status
Ready for Review

## Story
**As a** System Operator,
**I want** to define thresholds (e.g., CPU > 90%) that trigger alerts,
**so that** I am informed of system issues automatically.

## Acceptance Criteria
1. Database schema for `alert_rules` (metric_name, operator, threshold, duration, tenant_id).
2. An evaluator job runs periodically (e.g., every 30s) to check rules against recent metrics.
3. Alerts are stateful: they transition from `OK` -> `PENDING` -> `FIRING` based on the rule's duration.
4. An `alerts` table tracks the history of these state transitions.

## Tasks / Subtasks
- [x] **Database Migrations for Alerting** (AC: 1, 4)
    - [x] Create `alert_rules` table. [Source: architecture/4-data-models.md#alertrule]
    - [x] Create `alerts` table (tracks current state and history).
- [x] **Alert Rule Management API/UI Placeholder** (AC: 1)
    - [x] Create Model and basic CRUD logic for `AlertRule`.
- [x] **Alert Evaluator Engine** (AC: 2, 3)
    - [x] Create `EvaluateAlertRules` Job/Command.
    - [x] Logic to query `alert_rules` and check against recent `metrics_raw` data.
    - [x] Implement state machine logic:
        - `OK` -> `PENDING`: If threshold breached but `duration` not yet met.
        - `PENDING` -> `FIRING`: If threshold remains breached for `duration`.
        - `FIRING`/`PENDING` -> `OK`: If threshold no longer breached.
    - [x] Record state changes in the `alerts` table.
- [x] **Scheduling** (AC: 2)
    - [x] Schedule evaluation to run every 30-60 seconds in `routes/console.php`.
- [x] **Unit and Integration Testing**
    - [x] Test state transition logic (OK -> PENDING -> FIRING).
    - [x] Test that alerts are correctly isolated by `tenant_id`.

## Dev Notes
### Data Models
- **AlertRule**:
    - `id`: UUID
    - `tenant_id`: UUID
    - `metric_name`: String
    - `operator`: Enum (>, <, =, >=, <=)
    - `threshold`: Double
    - `duration`: Integer (Seconds condition must persist)
    - [Source: architecture/4-data-models.md#alertrule]
- **Alert** (Suggested Schema):
    - `id`: UUID
    - `tenant_id`: UUID
    - `alert_rule_id`: UUID
    - `state`: Enum (OK, PENDING, FIRING)
    - `started_at`: Timestamp
    - `last_checked_at`: Timestamp

### File Locations
- Migrations: `app/database/migrations/`
- Alert Evaluator: `app/app/Jobs/EvaluateAlertRules.php`
- Models: `app/app/Models/AlertRule.php`, `app/app/Models/Alert.php`

### Testing
- Ensure evaluation logic handles high-volume metric data efficiently. [Source: architecture/10-security-and-performance.md]
- Standard: Use Laravel's built-in testing suite.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-18 | 0.1 | Initial draft for Epic 4 | Bob (Scrum Master) |
| 2026-01-19 | 1.0 | Implementation complete - all tasks and tests passing | James (Dev Agent) |

## Dev Agent Record
### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
N/A - All tests pass without requiring debug logs

### Completion Notes List
- Successfully implemented stateful alerting engine with complete state machine (OK -> PENDING -> FIRING)
- Fixed initial timing issue in EvaluateAlertRules job where `diffInSeconds()` was calculating difference in wrong direction
- All acceptance criteria met and verified through comprehensive test suite
- Implemented 6 test cases covering all state transitions, tenant isolation, and operator validation
- All 85 tests in the full test suite pass

### File List
#### Created Files
- `app/database/migrations/2026_01_18_233124_create_alert_rules_table.php` - Alert rules table migration
- `app/database/migrations/2026_01_18_233156_create_alerts_table.php` - Alerts table migration
- `app/app/Models/AlertRule.php` - AlertRule model with relationships
- `app/app/Models/Alert.php` - Alert model with relationships
- `app/app/Jobs/EvaluateAlertRules.php` - Alert evaluation job with state machine logic
- `app/tests/Feature/AlertEvaluationTest.php` - Comprehensive test suite for alert evaluation

#### Modified Files
- `app/routes/console.php` - Added scheduled job for alert evaluation (every 30 seconds)

## QA Results
<!-- Results from QA Agent QA review of the completed story implementation -->