# Story 1.2: Multi-tenant Auth & API Token Management

## Status
Done

## Story
**As a** System Operator,
**I want** to generate secure API tokens for different tenants,
**so that** metric ingestion is isolated and authenticated.

## Acceptance Criteria
1. Database schema includes a `tenants` table and a `tokens` table (linked to tenants).
2. An Artisan command or internal API exists to create a new Tenant and generate an associated API token.
3. Middleware validates the `Authorization: Bearer <token>` header on protected routes.
4. Requests with invalid tokens return a `401 Unauthorized` response.

## Tasks / Subtasks
- [x] Task 1: Database Schema & Models (AC: 1)
    - [x] Create migration for `tenants` table with `id` (UUID), `name` (string), and `settings` (JSON). [Source: architecture/4-data-models.md#tenant]
    - [x] Create migration for `tenant_tokens` table with `id`, `tenant_id` (foreign key to tenants), `token` (hashed string), and `last_used_at`.
    - [x] Create `App\Models\Tenant` model with UUID trait.
    - [x] Create `App\Models\TenantToken` model.
- [x] Task 2: Tenant & Token Management (AC: 2)
    - [x] Create Artisan command `php artisan tenant:create {name}`.
    - [x] Implement logic to create a Tenant and generate a secure 64-character random token.
    - [x] Store the SHA-256 hash of the token in the database.
    - [x] Output the clear-text token to the console (only shown once).
- [x] Task 3: Authentication Middleware (AC: 3, 4)
    - [x] Create `App\Http\Middleware\AuthenticateTenantToken` middleware.
    - [x] Implement logic to extract Bearer token from the `Authorization` header.
    - [x] Verify the token against the `tenant_tokens` table (hashing the input and comparing).
    - [x] If valid, optionally bind the tenant to the request context (e.g., `$request->attributes->set('tenant', $tenant)`).
    - [x] If invalid or missing, return `401 Unauthorized`.
    - [x] Register the middleware in `bootstrap/app.php`.
- [x] Task 4: Verification and Testing (AC: 4)
    - [x] Create a protected test route `GET /api/v1/auth-test`.
    - [x] Write Feature tests in `app/tests/Feature/TenantAuthTest.php`:
        - [x] Test successful authentication with a valid token.
        - [x] Test 401 response with an invalid token.
        - [x] Test 401 response with a missing token.

## Dev Notes
- **Multi-tenancy:** The system uses UUIDs for tenant identification. Scoped queries (e.g., `TenantScope`) are mentioned in the security docs for later implementation, but for now, ensure the `tenant_id` is correctly associated. [Source: architecture/10-security-and-performance.md#security]
- **Auth Strategy:** Token-based authentication is required for the ingestion API. [Source: architecture/10-security-and-performance.md#security]
- **Data Model - Tenant:**
    - `id`: UUID (Primary Key)
    - `name`: String
    - `settings`: JSON (Source: architecture/4-data-models.md#tenant)
- **Implementation Note:** Laravel Sanctum is NOT currently in `composer.json`. Use a simple custom token implementation as described in the tasks to avoid adding dependencies unless necessary.
- **Previous Story Insights:**
    - The environment is correctly setup with MariaDB and Redis.
    - Ensure migrations use the correct database connection.
    - PHP 8.2+ features should be used.

### Testing
- **Backend Testing:** Use Laravel's built-in PHPUnit/Pest suite. Tests should be located in `app/tests/Feature`.
- **Standards:** Follow standard Laravel testing patterns (RefreshDatabase trait).

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-18 | 1.0 | Initial Story Draft | Bob (Scrum Master) |
| 2026-01-18 | 1.1 | Story implementation completed - All tasks and tests passing | James (Dev Agent) |

## Dev Agent Record
### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
None

### Completion Notes List
- Successfully implemented multi-tenant authentication system with API token management
- All acceptance criteria met:
  - Database schema created with `tenants` and `tenant_tokens` tables
  - Artisan command `tenant:create` implemented for tenant and token generation
  - Middleware validates Bearer tokens and returns 401 for invalid/missing tokens
  - All tests pass (3/3 tenant auth tests + full regression suite)
- Token security: SHA-256 hashing implemented, clear-text tokens only shown once during generation
- Middleware updates `last_used_at` timestamp on successful authentication
- Tenant context bound to request for downstream use

### File List
**New Files:**
- `app/database/migrations/2026_01_17_213130_create_tenants_table.php`
- `app/database/migrations/2026_01_17_213145_create_tenant_tokens_table.php`
- `app/app/Models/Tenant.php`
- `app/app/Models/TenantToken.php`
- `app/app/Console/Commands/TenantCreate.php`
- `app/app/Http/Middleware/AuthenticateTenantToken.php`
- `app/routes/api.php`
- `app/tests/Feature/TenantAuthTest.php`

**Modified Files:**
- `app/bootstrap/app.php` (registered middleware alias and API routes)

## QA Results

### Review Date: 2026-01-18

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
The implementation is solid and follows Laravel best practices. The use of SHA-256 hashing for tokens and the separation of concerns between the Artisan command, Middleware, and Models are well-executed. Acceptance criteria are fully met with passing tests.

### Refactoring Performed
I performed minor refactoring to improve performance and test coverage.

- **File**: `app/app/Http/Middleware/AuthenticateTenantToken.php`
  - **Change**: Added throttling to the `last_used_at` update logic (max once per minute).
  - **Why**: The ingestion API is expected to be high-volume. Updating the database on every single request would create unnecessary load and potential lock contention.
  - **How**: Checks if the timestamp is null or older than 1 minute before performing an update.

- **File**: `app/tests/Feature/TenantAuthTest.php`
  - **Change**: Added `test_tenant_isolation` test case.
  - **Why**: To explicitly verify that tokens are bound to the correct tenant context and cannot access other tenants.
  - **How**: Creates two tenants/tokens and asserts the request context matches the used token.

### Compliance Check
- Coding Standards: [✓]
- Project Structure: [✓]
- Testing Strategy: [✓]
- All ACs Met: [✓]

### Improvements Checklist
- [x] Refactored middleware to throttle DB writes (AuthenticateTenantToken.php)
- [x] Added multi-tenant isolation test (TenantAuthTest.php)
- [ ] Implement global `TenantScope` in the next story to eliminate the risk of manual filtering errors.
- [ ] Consider caching the hashed token lookup if ingestion volume exceeds DB performance limits.

### Security Review
Tokens are stored securely using SHA-256. Plain-text tokens are only displayed once during creation. The primary security risk is the deferred implementation of global tenant scoping, which requires developers to manually filter by `tenant_id` in subsequent stories.

### Performance Considerations
The middleware now throttles `last_used_at` updates. Further performance gains could be achieved by caching the tenant/token association in Redis.

### Files Modified During Review
- `app/app/Http/Middleware/AuthenticateTenantToken.php`
- `app/tests/Feature/TenantAuthTest.php`
- `app/phpunit.xml` (Enabled SQLite for local testing)

### Gate Status
Gate: CONCERNS → docs/qa/gates/1.2-multi-tenant-auth.yml
Risk profile: docs/qa/assessments/1.2.multi-tenant-auth-risk-20260118.md
Test design: docs/qa/assessments/1.2.multi-tenant-auth-test-design-20260118.md

### Recommended Status
[✓ Ready for Done] (Conditional on prioritizing global scoping in the next sprint)

