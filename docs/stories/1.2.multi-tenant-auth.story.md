# Story 1.2: Multi-tenant Auth & API Token Management

## Status
Ready

## Story
**As a** System Operator,
**I want** to generate secure API tokens for different tenants,
**so that** metric ingestion is isolated and authenticated.

## Acceptance Criteria
1. Database schema includes a `tenants` table and a `tokens` table (linked to tenants).
2. An Artisan command or internal API exists to create a new Tenant and generate an associated API token.
3. Middleware validates the `Authorization: Bearer <token>` header on protected routes.
4. Requests with invalid tokens return a `401 Unauthorized` response.

## Tasks / Subtasks
- [ ] Task 1: Database Schema & Models (AC: 1)
    - [ ] Create migration for `tenants` table with `id` (UUID), `name` (string), and `settings` (JSON). [Source: architecture/4-data-models.md#tenant]
    - [ ] Create migration for `tenant_tokens` table with `id`, `tenant_id` (foreign key to tenants), `token` (hashed string), and `last_used_at`.
    - [ ] Create `App\Models\Tenant` model with UUID trait.
    - [ ] Create `App\Models\TenantToken` model.
- [ ] Task 2: Tenant & Token Management (AC: 2)
    - [ ] Create Artisan command `php artisan tenant:create {name}`.
    - [ ] Implement logic to create a Tenant and generate a secure 64-character random token.
    - [ ] Store the SHA-256 hash of the token in the database.
    - [ ] Output the clear-text token to the console (only shown once).
- [ ] Task 3: Authentication Middleware (AC: 3, 4)
    - [ ] Create `App\Http\Middleware\AuthenticateTenantToken` middleware.
    - [ ] Implement logic to extract Bearer token from the `Authorization` header.
    - [ ] Verify the token against the `tenant_tokens` table (hashing the input and comparing).
    - [ ] If valid, optionally bind the tenant to the request context (e.g., `$request->attributes->set('tenant', $tenant)`).
    - [ ] If invalid or missing, return `401 Unauthorized`.
    - [ ] Register the middleware in `bootstrap/app.php`.
- [ ] Task 4: Verification and Testing (AC: 4)
    - [ ] Create a protected test route `GET /api/v1/auth-test`.
    - [ ] Write Feature tests in `app/tests/Feature/TenantAuthTest.php`:
        - [ ] Test successful authentication with a valid token.
        - [ ] Test 401 response with an invalid token.
        - [ ] Test 401 response with a missing token.

## Dev Notes
- **Multi-tenancy:** The system uses UUIDs for tenant identification. Scoped queries (e.g., `TenantScope`) are mentioned in the security docs for later implementation, but for now, ensure the `tenant_id` is correctly associated. [Source: architecture/10-security-and-performance.md#security]
- **Auth Strategy:** Token-based authentication is required for the ingestion API. [Source: architecture/10-security-and-performance.md#security]
- **Data Model - Tenant:**
    - `id`: UUID (Primary Key)
    - `name`: String
    - `settings`: JSON (Source: architecture/4-data-models.md#tenant)
- **Implementation Note:** Laravel Sanctum is NOT currently in `composer.json`. Use a simple custom token implementation as described in the tasks to avoid adding dependencies unless necessary.
- **Previous Story Insights:**
    - The environment is correctly setup with MariaDB and Redis.
    - Ensure migrations use the correct database connection.
    - PHP 8.2+ features should be used.

### Testing
- **Backend Testing:** Use Laravel's built-in PHPUnit/Pest suite. Tests should be located in `app/tests/Feature`.
- **Standards:** Follow standard Laravel testing patterns (RefreshDatabase trait).

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-18 | 1.0 | Initial Story Draft | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
<!-- To be populated by Dev Agent -->

### Debug Log References
<!-- To be populated by Dev Agent -->

### Completion Notes List
<!-- To be populated by Dev Agent -->

### File List
<!-- To be populated by Dev Agent -->

## QA Results
<!-- To be populated by QA Agent -->
