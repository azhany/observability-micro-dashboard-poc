# Test Design: Story 1.4.ingestion-processing-idempotency

Date: 2026-01-18
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 9
- Unit tests: 4 (44%)
- Integration tests: 5 (56%)
- E2E tests: 0 (0%)
- Priority distribution: P0: 5, P1: 2, P2: 2

## Test Scenarios by Acceptance Criteria

### AC1: Ingested metrics are dispatched to a Redis-backed Laravel Job

#### Scenarios

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 1.4-INT-001  | Integration | P0       | Metric dispatch to Queue  | Verify correct job push  |
| 1.4-UNIT-001 | Unit        | P1       | Job Serialization         | Ensure payload integrity |

### AC2: Job worker persists metrics to the `metrics_raw` table in MariaDB

#### Scenarios

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 1.4-INT-002  | Integration | P0       | Successful DB Persistence | Core requirement         |
| 1.4-UNIT-002 | Unit        | P1       | Metric Model Validation   | Model constraints logic  |
| 1.4-INT-003  | Integration | P0       | Binary UUID Storage       | Data integrity check     |

### AC3: The system uses a `dedupe_id` (if provided in payload) to prevent duplicate entries for the same event

#### Scenarios

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 1.4-INT-004  | Integration | P0       | Tenant-scoped Idempotency | Prevents data corruption |
| 1.4-UNIT-003 | Unit        | P2       | Dedupe ID Logic           | Conditional logic check  |

### AC4: Failed jobs are automatically retried with exponential backoff

#### Scenarios

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 1.4-INT-005  | Integration | P0       | Job Retry Mechanism       | System resilience        |
| 1.4-UNIT-004 | Unit        | P2       | Backoff Config Check      | Configuration verification |

## Risk Coverage

- **DATA-001 (Global dedupe_id collision)**: Covered by `1.4-INT-004` (Tenant-scoped Idempotency). This test explicitly verifies that the same `dedupe_id` can be used by different tenants without collision.
- **PERF-001 (DB lock contention)**: Covered by `1.4-INT-002` (Successful DB Persistence) when run with bulk inserts in the test suite.
- **TECH-001 (Binary UUID conversion)**: Covered by `1.4-INT-003` (Binary UUID Storage).

## Recommended Execution Order

1. P0 Unit tests (fail fast) - *Note: No P0 units defined, starting with P1.*
2. P0 Integration tests: `1.4-INT-001`, `1.4-INT-002`, `1.4-INT-003`, `1.4-INT-004`, `1.4-INT-005`
3. P1 Unit tests: `1.4-UNIT-001`, `1.4-UNIT-002`
4. P2 Unit tests: `1.4-UNIT-003`, `1.4-UNIT-004`
