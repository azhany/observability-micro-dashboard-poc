# Test Design: Story 3.1.mqtt-broker-bridge

Date: 2026-01-18
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 7
- Unit tests: 2
- Integration tests: 3
- E2E tests: 2
- Priority distribution: P0: 3, P1: 2, P2: 2

## Test Scenarios by Acceptance Criteria

### AC1: Mosquitto container added to `docker-compose.yml`

#### Scenarios

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 3.1-INT-001  | Integration | P0       | Container Health Check    | Verifies the broker starts and listens on 1883/9001. |

### AC2: A "Bridge" service subscribes to `metrics/#`
### AC3: The bridge parses the topic structure
### AC4: Parsed messages are forwarded to the existing ingestion pipeline

#### Scenarios

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 3.1-UNIT-001 | Unit        | P0       | Topic Parsing Logic       | Critical pure logic to extract IDs from topic string.    |
| 3.1-UNIT-002 | Unit        | P1       | Payload Validation        | Ensure JSON structure is valid before processing.        |
| 3.1-INT-002  | Integration | P0       | Bridge-to-Job Dispatch    | Verifies the command receives a message and dispatches the job. Mocks MQTT client. |
| 3.1-INT-003  | Integration | P1       | Tenant Validation         | Verifies the bridge rejects metrics for non-existent tenants. |
| 3.1-E2E-001  | E2E         | P2       | End-to-End Ingestion      | Pub to Mosquitto -> Bridge -> Job -> Redis (Manual/Smoke). |
| 3.1-E2E-002  | E2E         | P2       | Resilience/Restart        | Kill bridge process, verify restart (Manual). |

## Risk Coverage

- **SEC-001 (Anonymous Access)**: Covered implicitly by configuration review; E2E-001 should eventually fail if auth is enforced and not provided (future).
- **OPS-001 (Process Lifecycle)**: Covered by 3.1-E2E-002 (Resilience).
- **DATA-001 (Malformed Topic)**: Covered by 3.1-UNIT-001 (Topic Parsing).
- **PERF-001 (Memory Leaks)**: Not covered by automated tests in this design; requires manual load testing as per Risk Profile.

## Recommended Execution Order

1. **3.1-UNIT-001, 3.1-UNIT-002**: Validate logic first.
2. **3.1-INT-001**: Ensure infrastructure is up.
3. **3.1-INT-002**: Verify the bridge command works in isolation.
4. **3.1-E2E-001**: full flow verification.
