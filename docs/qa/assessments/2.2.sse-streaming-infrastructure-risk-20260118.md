# Risk Profile: Story 2.2.sse-streaming-infrastructure

Date: 2026-01-18
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 6
- Critical Risks: 1
- High Risks: 2
- Risk Score: 51/100

## Critical Risks Requiring Immediate Attention

### 1. PERF-001: Server Resource Exhaustion (PHP-FPM Worker Starvation)

**Score: 9 (Critical)**
**Probability**: High - Standard PHP-FPM setups have a fixed number of workers. Long-lived SSE connections will occupy these workers indefinitely, quickly leading to 502/504 errors for all other users as no workers remain to handle new requests.
**Impact**: High - Complete service denial for the dashboard and API.
**Mitigation**:
- Use a non-blocking server (e.g., Laravel Octane with Swoole/RoadRunner) for SSE endpoints.
- Alternatively, strictly limit the number of concurrent SSE connections per tenant/user.
- Implement short-lived SSE connections that client-side reconnects (e.g., 30-60s max duration).
**Testing Focus**: Load testing with concurrent connections to verify impact on standard API endpoints.

## Risk Distribution

### By Category

- Security: 1 risks (1 high)
- Performance: 2 risks (1 critical)
- Technical: 1 risks (1 medium)
- Data: 1 risks (1 low)
- Operational: 1 risks (1 high)

### By Component

- Frontend: 1 risks
- Backend: 4 risks
- Infrastructure: 1 risks

## Detailed Risk Register

| Risk ID  | Description                                     | Probability | Impact     | Score | Priority |
| -------- | ----------------------------------------------- | ----------- | ---------- | ----- | -------- |
| PERF-001 | PHP-FPM worker starvation due to long SSE       | High (3)    | High (3)   | 9     | Critical |
| SEC-001  | Cross-tenant data leakage via Redis channels    | Medium (2)  | High (3)   | 6     | High     |
| OPS-001  | Orphaned Redis subscriptions on disconnect      | High (3)    | Medium (2) | 6     | High     |
| TECH-001 | Blocking Redis subscribe hangs request thread   | Medium (2)  | Medium (2) | 4     | Medium   |
| DATA-001 | Data loss during connection drops               | High (3)    | Low (1)    | 3     | Low      |
| PERF-002 | Redis Pub/Sub overhead at high volume           | Low (1)     | Medium (2) | 2     | Low      |

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests
- **Worker Starvation Test**: Simulate 50+ concurrent SSE connections and verify if `GET /api/v1/health` or other endpoints still respond.
- **Connection Lifecycle**: Verify that closing the browser tab immediately triggers `Redis::unsubscribe` and terminates the PHP process.

### Priority 2: High Risk Tests
- **Multi-tenant Isolation**: Connect to `tenant-A` stream, trigger metric for `tenant-B`, and verify NO data is received.
- **Unauthorized Access**: Attempt to connect to a stream for a tenant the user does not belong to.

### Priority 3: Medium/Low Risk Tests
- **Reconnect Logic**: Simulate network drop and verify the client re-establishes the SSE connection.
- **Load Test**: Push 100 metrics/sec through a single tenant stream.

## Risk Acceptance Criteria

### Must Fix Before Production
- PERF-001: Mitigation for PHP worker starvation (Octane or connection limits).
- SEC-001: Robust tenant ID validation in `StreamController`.
- OPS-001: Explicit `disconnect` handling in the stream loop.

### Can Deploy with Mitigation
- TECH-001: Ensure `StreamedResponse` is used correctly with `flush()`.

### Accepted Risks
- DATA-001: Real-time streams are understood to be "best-effort". Clients should poll for historical data on load or reconnect.

## Monitoring Requirements
- PHP-FPM active process count.
- Redis Pub/Sub client count.
- SSE connection duration distribution.
- Rate of `401/403` errors on the stream endpoint.

## Risk Review Triggers
- Switch from Redis to another broadcasting driver (e.g., Ably, Pusher).
- Change in PHP execution environment (e.g., moving to Lambda/Serverless).
