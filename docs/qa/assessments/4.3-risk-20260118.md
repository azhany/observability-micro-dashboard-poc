# Risk Profile: Story 4.3 Notification Dispatch (Webhook & Email)

Date: 2026-01-18
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 5
- Critical Risks: 0
- High Risks: 1
- Risk Score: 79/100 (Low-Medium Risk)

The notification dispatch system is the "last mile" of alerting. While technically straightforward using Laravel's notification system, the primary risks involve the reliability of external endpoints (webhooks) and ensuring the system doesn't accidentally spam users due to logic errors.

## High Risks Requiring Attention

### 1. TECH-004: Webhook Delivery Failure & Retries

**Score: 6 (High)**
**Probability**: High - External webhook endpoints are frequently unreliable, slow, or temporarily down.
**Impact**: Medium - Critical alerts may be missed if the delivery fails and isn't retried appropriately.
**Mitigation**:
- Use Laravel's queued notifications with a defined retry policy (exponential backoff).
- Set a reasonable timeout (e.g., 5-10 seconds) for the HTTP request to prevent queue blocking.
- Log webhook failures for operator visibility.
**Testing Focus**: Simulate webhook endpoint timeouts and 500 errors to verify retry behavior.

## Risk Distribution

### By Category
- **Technical**: 2 risks (1 high)
- **Operational**: 1 risk
- **Performance**: 1 risk
- **Data**: 1 risk

### By Component
- **Notification Dispatcher**: 3 risks
- **External Integration (Webhook/SMTP)**: 2 risks

## Detailed Risk Register

| Risk ID  | Description | Probability | Impact | Score | Priority |
| :--- | :--- | :--- | :--- | :--- | :--- |
| TECH-004 | Webhook Delivery Failure | High (3) | Medium (2) | 6 | High |
| OPS-002  | Notification Spam (Spurious Triggers) | Medium (2) | Medium (2) | 4 | Medium |
| PERF-006 | Dispatch Queue Congestion | Low (1) | Medium (2) | 2 | Low |
| DATA-003 | Malformed Notification Config | Medium (2) | Low (1) | 2 | Low |
| SEC-002  | Unsigned Webhook Payload | Low (1) | Medium (2) | 2 | Low |

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests
- **State Transition Logic**: Verify that a notification is sent *exactly once* when transitioning to `FIRING`. Test sequences: `OK -> FIRING (Notify)`, `FIRING -> FIRING (No Notify)`, `FIRING -> OK (No Notify)`.
- **Failure Resilience**: Mock a failing webhook (5xx) and verify the job is released back to the queue for retry.

### Priority 2: High Risk Tests
- **Payload Validation**: Ensure the webhook payload contains all required fields (Tenant, Metric, Value, Timestamp) and that values are correctly escaped.
- **Email Simulation**: Verify email generation using Mailpit/Log and check for correct formatting and link validity.

### Priority 3: Medium/Low Risk Tests
- **Invalid Config Handling**: Provide an invalid URL (e.g., `not-a-url`) and verify the system fails gracefully without crashing the evaluator job.

## Risk Acceptance Criteria

### Must Fix Before Production
- Queued notification handling with retries (TECH-004).
- Verification of "notify on transition only" logic (OPS-002).
- Basic validation of webhook URLs and email formats.

### Can Deploy with Mitigation
- Webhook signing/security (SEC-002) can be a P2 enhancement unless the payload contains highly sensitive PII.

## Monitoring Requirements
- **Notification Failure Rate**: Monitor the ratio of failed vs. successful webhook/email dispatches.
- **Queue Lag**: Monitor the time between alert firing and notification dispatch.
- **Webhook Latency**: Track the response time of external webhook endpoints.

## Risk Review Triggers
- Adding more notification channels (Slack, SMS, etc.).
- Significant increase in the volume of simultaneous alerts.
- Requirement for encrypted or signed notification payloads.
