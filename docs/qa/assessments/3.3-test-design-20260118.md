# Test Design: Story 3.3

Date: 2026-01-18
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 7
- Unit tests: 3 (43%)
- Integration tests: 3 (43%)
- E2E tests: 1 (14%)
- Priority distribution: P0: 4, P1: 2, P2: 1

## Test Scenarios by Acceptance Criteria

### AC1: MQTT client connection to Mosquitto broker

| ID | Level | Priority | Test | Justification |
| -- | ----- | -------- | ---- | ------------- |
| 3.3-INT-001 | Integration | P0 | Successful connection with valid credentials | Verifies network and authentication setup with a real/mock broker. |
| 3.3-INT-002 | Integration | P1 | Connection failure with invalid credentials | Ensures the client handles authentication errors correctly. |

### AC2: Required topic structure: `metrics/{tenant_id}/{agent_id}/{metric_name}`

| ID | Level | Priority | Test | Justification |
| -- | ----- | -------- | ---- | ------------- |
| 3.3-UNIT-001 | Unit | P0 | Topic string generator logic | Pure string formatting logic; critical for MQTT Bridge compatibility. |

### AC3: Graceful connection retries

| ID | Level | Priority | Test | Justification |
| -- | ----- | -------- | ---- | ------------- |
| 3.3-INT-003 | Integration | P0 | Automatic reconnect after broker restart | Critical for long-running agent stability. |
| 3.3-UNIT-002 | Unit | P2 | Exponential backoff timing | Verifies the math/logic for retry delays. |

### AC4: `agent_id` and `timestamp` in payload

| ID | Level | Priority | Test | Justification |
| -- | ----- | -------- | ---- | ------------- |
| 3.3-UNIT-003 | Unit | P0 | JSON payload marshaling | Verifies that the required fields are present in the serialized output. |

### AC5: Configuration via environment variables

| ID | Level | Priority | Test | Justification |
| -- | ----- | -------- | ---- | ------------- |
| 3.3-E2E-001 | E2E | P1 | End-to-end flow from Agent to MQTT Bridge | Validates that env vars are correctly parsed and used to establish the full pipeline. |

## Risk Coverage (Ref: 3.3-risk)

- **SEC-001 (Unencrypted MQTT)**: Covered by INT-001 (verifying connection works, manually checking logs for plaintext if needed).
- **DATA-001 (Data loss during disconnect)**: Covered by INT-003 (verifying behavior during broker downtime).
- **TECH-002 (Topic structure)**: Directly covered by UNIT-001.

## Recommended Execution Order

1. **3.3-UNIT-001 & 3.3-UNIT-003**: Validate core logic (topic and payload) immediately.
2. **3.3-INT-001**: Establish basic connectivity.
3. **3.3-INT-003**: Verify robustness (retries).
4. **3.3-E2E-001**: Final verification of the full observability pipeline.
