# Test Design: Story 1.2.multi-tenant-auth

Date: 2026-01-18
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 9
- Unit tests: 4 (44%)
- Integration tests: 4 (44%)
- E2E tests: 1 (11%)
- Priority distribution: P0: 5, P1: 3, P2: 1

## Test Scenarios by Acceptance Criteria

### AC1: Database schema includes a `tenants` table and a `tokens` table

#### Scenarios

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 1.2-INT-001  | Integration | P0       | Database Schema Validation | Verify foreign key constraints and UUID generation at the DB level. Essential for data integrity. |

### AC2: Artisan command or internal API exists to create a new Tenant and generate an associated API token

#### Scenarios

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 1.2-UNIT-001 | Unit        | P0       | Token Generation Logic    | Ensure tokens are 64 characters and randomly generated. Pure logic test. |
| 1.2-UNIT-002 | Unit        | P0       | Token Hashing Logic       | Verify SHA-256 hashing correctness before storage. Security critical. |
| 1.2-INT-002  | Integration | P1       | Artisan Command Execution | Verify command creates DB records and outputs plain text token once. |
| 1.2-INT-003  | Integration | P2       | Duplicate Tenant handling | Ensure command handles duplicate names gracefully. |

### AC3: Middleware validates the `Authorization: Bearer <token>` header

#### Scenarios

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 1.2-UNIT-003 | Unit        | P1       | Middleware Token Extraction | Test logic for parsing Bearer header. Isolated logic. |
| 1.2-INT-004  | Integration | P0       | Middleware Database Verification | Verify middleware correctly hashes input and finds matching record in DB. |

### AC4: Requests with invalid tokens return a `401 Unauthorized` response

#### Scenarios

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 1.2-UNIT-004 | Unit        | P1       | 401 Response Logic        | Verify correct status code and JSON structure for auth failures. |
| 1.2-E2E-001  | E2E         | P0       | Protected Route Access    | Verify full request flow: Valid token -> 200, Invalid/Missing -> 401. Covers AC3 & AC4 end-to-end. |

## Risk Coverage

- **DATA-001 (Cross-tenant Data Isolation)**: Partially covered by 1.2-E2E-001 (ensuring valid auth), but primarily relies on future tenant scoping tests.
- **SEC-001 (Token Leakage)**: Covered by 1.2-INT-002 (ensuring command output behavior).
- **SEC-002 (Custom Auth Flaws)**: Covered by 1.2-UNIT-001, 1.2-UNIT-002, 1.2-INT-004.
- **SEC-003 (Lifecycle)**: Not covered (out of scope for this story).

## Recommended Execution Order

1.  **P0 Unit**: 1.2-UNIT-001, 1.2-UNIT-002 (Security primitives)
2.  **P0 Integration**: 1.2-INT-001, 1.2-INT-004 (Schema & Auth flow)
3.  **P0 E2E**: 1.2-E2E-001 (Full protection verification)
4.  **P1 Unit/Integration**: 1.2-UNIT-003, 1.2-UNIT-004, 1.2-INT-002
5.  **P2 Integration**: 1.2-INT-003
