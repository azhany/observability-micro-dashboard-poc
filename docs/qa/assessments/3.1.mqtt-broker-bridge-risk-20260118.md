# Risk Profile: Story 3.1.mqtt-broker-bridge

Date: 2026-01-18
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 6
- Critical Risks: 1
- High Risks: 1
- Risk Score: 56/100

## Critical Risks Requiring Immediate Attention

### 1. SEC-001: Anonymous Access in Mosquitto

**Score: 9 (Critical)**
**Probability**: High (3) - The story explicitly mentions anonymous access is enabled for the PoC.
**Impact**: High (3) - Allows any client on the network to inject metrics or potentially subscribe to sensitive data streams if not restricted.
**Mitigation**:
- **Strategy**: Preventive
- **Actions**: 
    - Implement username/password authentication in `mosquitto.conf`.
    - Restrict topic access using ACLs.
- **Testing Focus**: Security penetration tests to attempt unauthorized publishing and subscription.

## Risk Distribution

### By Category

- Security: 2 risks (1 critical)
- Performance: 1 risks
- Data: 1 risks
- Operational: 1 risks (1 high)
- Technical: 1 risks

### By Component

- Infrastructure (Mosquitto): 2 risks
- Backend (Artisan Bridge): 4 risks

## Detailed Risk Register

| Risk ID  | Description                                 | Probability | Impact     | Score | Priority |
| -------- | ------------------------------------------- | ----------- | ---------- | ----- | -------- |
| SEC-001  | Anonymous access in Mosquitto               | High (3)    | High (3)   | 9     | Critical |
| OPS-001  | Bridge process lifecycle management         | Medium (2)  | High (3)   | 6     | High     |
| PERF-001 | PHP memory leaks in long-running bridge     | Medium (2)  | Medium (2) | 4     | Medium   |
| DATA-001 | Malformed MQTT topic parsing                | Medium (2)  | Medium (2) | 4     | Medium   |
| SEC-002  | Malicious payload injection                 | Low (1)     | High (3)   | 3     | Low      |
| TECH-001 | Mosquitto persistence failure               | Low (1)     | Medium (2) | 2     | Low      |

## Risk-Based Testing Strategy

### Priority 1: Critical & High Risk Tests

- **Unauthorized Access Attempt**: Verify that the broker rejects connections without credentials (once mitigation is applied).
- **Process Resilience**: Manually kill the `mqtt:bridge` process and ensure it is automatically restarted (test against Supervisor/Process Manager).
- **Leak Detection**: Run the bridge for 1 hour under constant load and monitor memory usage in the container.

### Priority 2: Medium Risk Tests

- **Topic Fuzzing**: Publish to topics like `metrics/invalid-uuid/agent/name`, `metrics/123/456`, `metrics///`, etc., and ensure the bridge logs an error but stays alive.
- **Payload Validation**: Send non-JSON payloads and JSON missing required fields (`value`).

### Priority 3: Low Risk Tests

- **Persistence Check**: Restart the Mosquitto container and ensure it retains its state (if any retained messages are used) and that the volume mapping works.

## Risk Acceptance Criteria

### Must Fix Before Production

- SEC-001: Anonymous access must be disabled.
- OPS-001: A production-ready process manager (Supervisor) must be configured.

### Can Deploy with Mitigation

- PERF-001: Can deploy if basic monitoring is in place and memory usage is documented as stable for short durations.
- DATA-001: Requires basic try/catch blocks; comprehensive validation can be iterative.

### Accepted Risks

- Tech-001: Low risk for PoC phase.

## Monitoring Requirements

- **Memory Usage**: Monitor the Resident Set Size (RSS) of the `php artisan mqtt:bridge` process.
- **MQTT Connection Status**: Alert if the bridge disconnects from the broker for > 30 seconds.
- **Error Logs**: Aggregate and alert on "Malformed topic" or "Validation failed" errors in the bridge.

## Risk Review Triggers

- Change in MQTT library (`php-mqtt/client`).
- Introduction of TLS for MQTT connections.
- Scaling to multiple bridge instances (partitioning logic).
