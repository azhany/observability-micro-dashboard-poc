# Risk Profile: Story 3.3

Date: 2026-01-18
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 6
- Critical Risks: 0
- High Risks: 3
- Risk Score: 58/100 (High Risk signals present)

## High Risks Requiring Attention

### 1. SEC-001: Unencrypted MQTT communication (No TLS)

**Score: 6 (High)**
**Probability**: Medium - Standard development setups and the current PRD/Architecture don't explicitly mandate TLS for the agent-to-broker connection.
**Impact**: High - Credentials (`bridge_user`/`bridge_pass`) and system metrics are sent in plaintext, vulnerable to interception in non-isolated networks.
**Mitigation**:
- Support `mqtts://` protocol and TLS configuration.
- Document that the current version is intended for trusted/internal networks only.
**Testing Focus**: Verify that the agent can connect via TLS if configured.

### 2. DATA-001: Data loss during broker disconnection

**Score: 6 (High)**
**Probability**: High - Network interruptions or broker restarts will occur. The current design has no local buffering.
**Impact**: Medium - While not mission-critical for a POC, it results in gaps in observability which can mask issues during the outage.
**Mitigation**:
- Implement a simple ring-buffer or channel-based queue to hold a limited number of metrics during brief outages.
- Acknowledge this as a known limitation for the initial POC.
**Testing Focus**: Simulate broker downtime and verify behavior (drop vs. retry).

### 3. TECH-002: Incorrect topic structure formatting

**Score: 6 (High)**
**Probability**: Medium - The topic structure `metrics/{tenant_id}/{agent_id}/{metric_name}` is strict. Manual string concatenation or missing IDs will break the MQTT Bridge.
**Impact**: High - Metrics will be published but never processed or stored, leading to a "silent failure" where the agent looks healthy but no data appears.
**Mitigation**:
- Use a dedicated helper function for topic construction.
- Unit tests validating the topic string against expected patterns.
**Testing Focus**: Integration test verifying that metrics published by the Go agent are correctly picked up by the Laravel MQTT Bridge.

## Risk Distribution

### By Category

- Technical: 2 risks (0 critical)
- Security: 1 risk (0 critical)
- Performance: 1 risk (0 critical)
- Data: 1 risk (0 critical)
- Operational: 1 risk (0 critical)

### By Component

- Go Agent (Publisher): 5 risks
- Mosquitto Broker: 1 risk (Operational)

## Detailed Risk Register

| Risk ID  | Description                            | Probability | Impact     | Score | Priority |
| -------- | -------------------------------------- | ----------- | ---------- | ----- | -------- |
| SEC-001  | Unencrypted MQTT communication         | Medium (2)  | High (3)   | 6     | High     |
| DATA-001 | Data loss during broker disconnection  | High (3)    | Medium (2) | 6     | High     |
| TECH-002 | Incorrect topic structure formatting   | Medium (2)  | High (3)   | 6     | High     |
| TECH-001 | Publisher blocking the collection loop | Medium (2)  | Medium (2) | 4     | Medium   |
| PERF-001 | Potential memory leak in MQTT client   | Medium (2)  | Medium (2) | 4     | Medium   |
| OPS-001  | Connection retry thundering herd       | Low (1)     | Medium (2) | 2     | Low      |

## Risk-Based Testing Strategy

### Priority 1: High Risk Tests

- **Topic Validation**: Unit test `GetTopic(metric)` to ensure it matches `metrics/tenant/agent/name`.
- **Connectivity Edge Cases**: Test behavior when the broker is down, then comes back up. Ensure the agent recovers without manual intervention.
- **Negative Auth**: Test behavior with incorrect credentials to ensure it doesn't crash or loop infinitely with high CPU.

### Priority 2: Medium Risk Tests

- **Concurrency Test**: Ensure publishing happens in a separate goroutine so it doesn't block the collection intervals.
- **Memory Stability**: Run the agent for 1 hour with high-frequency collection to monitor for memory growth.

### Priority 3: Low Risk Tests

- **Exponential Backoff**: Verify that retries increase in duration (e.g., 1s, 2s, 4s...) rather than a fixed 1s interval.

## Risk Acceptance Criteria

### Must Fix Before Production

- Topic formatting must be 100% accurate per `docs/MQTT_BRIDGE.md`.
- Connection recovery must be automated and robust.
- Basic security (credentials via env) must be implemented.

### Can Deploy with Mitigation

- Lack of TLS (Acceptable for POC if documented).
- Lack of local disk persistence for metrics (Acceptable for POC).

## Monitoring Requirements

- Log broker connection/disconnection events.
- Log publish errors (e.g., "failed to publish to topic X").

## Risk Review Triggers

- Change in MQTT Bridge requirements.
- Introduction of sensitive metrics (e.g., logs containing PII).
- Deployment to a public network.
