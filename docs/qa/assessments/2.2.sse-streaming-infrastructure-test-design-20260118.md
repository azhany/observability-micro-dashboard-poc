# Test Design: Story 2.2.sse-streaming-infrastructure

Date: 2026-01-18
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 8
- Unit tests: 2 (25%)
- Integration tests: 5 (62.5%)
- E2E tests: 1 (12.5%)
- Priority distribution: P0: 4, P1: 3, P2: 1

## Test Scenarios by Acceptance Criteria

### AC1: Laravel implementation of an SSE endpoint `GET /api/v1/stream/{tenant}`

#### Scenarios

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 2.2-INT-001  | Integration | P0       | Validate SSE Headers      | Core protocol compliance (text/event-stream, no-cache). |
| 2.2-INT-002  | Integration | P0       | Auth Middleware Enforcement| Security critical path. |

### AC2: The stream broadcasts new metric events immediately after they are persisted

#### Scenarios

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 2.2-UNIT-001 | Unit        | P1       | Job Publishes to Redis    | Verify `ProcessMetricSubmission` calls Redis publish after saving. |
| 2.2-INT-003  | Integration | P0       | End-to-End Stream Flow    | Verify `Job -> Redis -> Controller -> Client` chain using mocked Redis. |

### AC3: Redis Pub/Sub or a similar mechanism is used to bridge background ingestion

#### Scenarios

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 2.2-UNIT-002 | Unit        | P0       | Channel Name Logic        | Critical to prevent SEC-001 (Cross-tenant leakage). Verify `tenant.{uuid}.metrics`. |
| 2.2-INT-004  | Integration | P1       | Payload Structure         | Ensure JSON format matches frontend expectations. |

### AC4: Connection management ensures that streams are closed correctly

#### Scenarios

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 2.2-INT-005  | Integration | P1       | Client Disconnect Handling| Mitigates OPS-001/PERF-001. Verify loop termination on connection drop. |
| 2.2-E2E-001  | E2E         | P2       | Browser Reconnect         | Verify client re-establishes connection after network interrupt (manual/browser test). |

## Risk Coverage

- **PERF-001 (Worker Starvation):** Covered by `2.2-INT-005` (verifying rapid disconnect cleanup).
- **SEC-001 (Cross-tenant Leakage):** Covered by `2.2-UNIT-002` (Channel naming) and `2.2-INT-002` (Auth).
- **OPS-001 (Orphaned Subs):** Covered by `2.2-INT-005`.

## Recommended Execution Order

1. **P0 Unit:** `2.2-UNIT-002` (Channel logic) - Fail fast if privacy is broken.
2. **P0 Int:** `2.2-INT-001`, `2.2-INT-002`, `2.2-INT-003` - Verify core plumbing.
3. **P1 Unit/Int:** `2.2-UNIT-001`, `2.2-INT-004`, `2.2-INT-005` - Refine behavior.
4. **P2 E2E:** `2.2-E2E-001` - Manual verification in browser.
