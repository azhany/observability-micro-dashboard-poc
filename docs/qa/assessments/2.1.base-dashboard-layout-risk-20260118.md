# Risk Profile: Story 2.1 Base Dashboard Layout & Tenant View

Date: 2026-01-18
Reviewer: Quinn (Test Architect)

## Executive Summary

- **Total Risks Identified:** 6
- **Critical Risks:** 1
- **High Risks:** 2
- **Risk Score:** 51/100 (Moderate-High Risk)

## Critical Risks Requiring Immediate Attention

### 1. [PERF-001]: Distinct Agent Query on Raw Metrics

- **Score:** 9 (Critical)
- **Probability:** High (3) - `metrics_raw` table in observability systems grows rapidly (millions of rows).
- **Impact:** High (3) - Performing `SELECT DISTINCT agent_id` on a massive unindexed (or strictly time-indexed) table will cause page timeouts or database lock/stress, rendering the dashboard unusable.
- **Mitigation:**
    - **Strategy:** Preventive.
    - **Action:** Create a separate `agents` or `agent_registry` table that updates on first contact, OR ensure a covering index `(tenant_id, agent_id)` exists on `metrics_raw` (though distinct scan is still costly on huge datasets).
    - **Testing Focus:** Load testing with 1M+ rows in `metrics_raw`.

## Risk Distribution

### By Category

- **Technical:** 2 risks (0 Critical, 1 High)
- **Security:** 1 risk (0 Critical, 1 High)
- **Performance:** 1 risk (1 Critical, 0 High)
- **Business:** 1 risk (0 Critical, 0 High)
- **Operational:** 1 risk (0 Critical, 0 High)

## Detailed Risk Register

| Risk ID | Title | Prob | Impact | Score | Category | Mitigation Strategy |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **PERF-001** | **Slow Distinct Query on Huge Table** | 3 | 3 | **9** | Performance | **Must Fix:** Implement dedicated Agent lookup or optimized index. |
| **TECH-001** | **Binary(16) Tenant ID Handling** | 3 | 2 | **6** | Technical | **Preventive:** Ensure Model casts to/from UUID string; Controller validates UUID format. |
| **SEC-001** | **Tenant Data Isolation (IDOR)** | 2 | 3 | **6** | Security | **Preventive:** Middleware/Policy must verify `Auth::user()->tenant_id` matches route parameter. |
| **BUS-001** | **Ambiguous "Status" Definition** | 2 | 2 | **4** | Business | **Clarification:** Define "Status" (e.g., "Data received < 5 min ago"). Avoid N+1 query. |
| **OPS-001** | **Low Contrast in Dark Mode** | 2 | 1 | **2** | Operational | **Detective:** Verify contrast ratios (WCAG AA) for text on `#161B22` cards. |
| **TECH-002** | **Inertia Prop Type Mismatch** | 1 | 2 | **2** | Technical | **Detective:** Integration tests to verify prop structure matches Vue `defineProps`. |

## Risk-Based Testing Strategy

### Priority 1: Critical & High Risk Tests (Must Pass)

1.  **Performance Load Test (PERF-001):**
    -   Seed `metrics_raw` with 1,000,000 rows.
    -   Measure response time of `/dashboard`. Target: < 500ms.
2.  **Security IDOR Test (SEC-001):**
    -   Attempt to access Tenant B's details while logged in as Tenant A.
    -   Expect: 403 Forbidden.
3.  **Data Integrity Test (TECH-001):**
    -   Verify UUIDs are correctly rendered in HTML/JSON and not as garbage binary characters.

### Priority 2: Medium Risk Tests

1.  **Status Logic Verification (BUS-001):**
    -   Simulate agent offline > 5 mins (or defined threshold). Verify status badge changes.
    -   Ensure efficient query (no N+1).

## Risk Acceptance Criteria

### Must Fix Before Production

-   **PERF-001**: Cannot ship with full table scan on raw metrics.
-   **SEC-001**: Zero tolerance for cross-tenant data leaks.

### Can Deploy with Mitigation

-   **OPS-001**: Acceptable for PoC if users are internal/technical, but log as debt for Beta.

## Monitoring Requirements

-   **Database:** Slow query log monitoring for the Dashboard Overview query.
-   **Security:** Alert on 403 Forbidden spikes (potential enumeration attempts).
