# Risk Profile: Story 4.1 Automated Downsampling

Date: 2026-01-18
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 7
- Critical Risks: 0
- High Risks: 1
- Risk Score: 66/100 (Medium Risk)

The implementation of automated downsampling introduces significant operational and performance considerations. While the logic itself is straightforward, the scale of data and the potential for job overlaps or failures in a multi-tenant environment present the primary risks.

## High Risks Requiring Attention

### 1. PERF-003: Large Tenant Data Volume

**Score: 6 (High)**
**Probability**: Medium - It is likely that some tenants will have significantly higher metric density than others.
**Impact**: High - A single "noisy" tenant could cause the aggregation job to exceed memory limits or execution time, potentially stalling rollups for all other tenants.
**Mitigation**:
- Implement chunking by tenant in the `DownsampleMetrics` job.
- Use database-side aggregation (`INSERT INTO ... SELECT AVG(...)`) rather than pulling raw records into PHP memory.
- Add timeouts and resource monitoring for the aggregation process.
**Testing Focus**: Load testing with a "mega-tenant" profile to ensure resource stability.

## Risk Distribution

### By Category
- **Performance**: 3 risks (1 high)
- **Data**: 2 risks
- **Operational**: 1 risk
- **Technical**: 1 risk

### By Component
- **Backend (Jobs/Commands)**: 4 risks
- **Database**: 2 risks
- **API**: 1 risk

## Detailed Risk Register

| Risk ID  | Description | Probability | Impact | Score | Priority |
| :--- | :--- | :--- | :--- | :--- | :--- |
| PERF-003 | Large Tenant Data Volume | Medium (2) | High (3) | 6 | High |
| PERF-001 | Aggregation Job Overlap | Medium (2) | Medium (2) | 4 | Medium |
| OPS-001 | Missing "Catch-up" Logic | Medium (2) | Medium (2) | 4 | Medium |
| PERF-002 | Database Write Load | Medium (2) | Medium (2) | 4 | Medium |
| TECH-001 | Memory Exhaustion in PHP | Medium (2) | Medium (2) | 4 | Medium |
| DATA-001 | Retention Policy Error | Low (1) | High (3) | 3 | Low |
| DATA-002 | Rollup Calculation Inaccuracy | Low (1) | Medium (2) | 2 | Low |

## Risk-Based Testing Strategy

### Priority 1: High Risk Tests
- **Scale Test**: Simulate 1,000,000 raw records for a single tenant and verify 1m rollup performance.
- **Resource Profiling**: Monitor PHP memory usage during `DownsampleMetrics` execution.

### Priority 2: Medium Risk Tests
- **Overlap Test**: Force a rollup job to run longer than 1 minute and verify that the next scheduled run handles the lock or waits appropriately.
- **Gap Recovery**: Manually stop the scheduler for 5 minutes, then restart and verify if the system "catches up" on missing rollup windows.
- **Concurrency Test**: Run rollups and high-volume API queries simultaneously to check for DB deadlocks.

### Priority 3: Low Risk Tests
- **Retention Verification**: Run `CleanupOldMetrics` and verify exactly which records are deleted using a snapshot comparison.
- **Math Validation**: Compare manually calculated averages against the rollup table values.

## Risk Acceptance Criteria

### Must Fix Before Production
- Implementation of chunking or DB-side aggregation to handle large tenant volumes (PERF-003).
- Basic "Catch-up" mechanism or verification that gaps are handled (OPS-001).
- Overlap prevention (e.g., using Laravel's `withoutOverlapping()`).

### Can Deploy with Mitigation
- Retention policy can be deployed but requires strict monitoring and initial "dry-run" logs.

## Monitoring Requirements
- **Job Duration**: Track the execution time of `DownsampleMetrics`.
- **Worker Memory**: Monitor the peak memory usage of the background worker.
- **Table Size**: Alert on unexpected growth rates of `metrics_1m` and `metrics_5m`.
- **API Latency**: Monitor `MetricController` response times for `resolution` queries.

## Risk Review Triggers
- Significant increase in the number of active tenants.
- Change in the frequency of raw metric ingestion.
- Modifications to the database engine or storage layer.
