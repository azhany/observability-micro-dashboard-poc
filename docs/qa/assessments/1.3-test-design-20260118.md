# Test Design: Story 1.3 - HTTP Metric Ingestion API

Date: 2026-01-18
Designer: Quinn (Test Architect)

## Test Strategy Overview

- **Total test scenarios**: 11
- **Unit tests**: 5 (45%)
- **Integration tests**: 5 (45%)
- **E2E tests**: 1 (10%)
- **Priority distribution**: P0: 5, P1: 4, P2: 2

## Test Scenarios by Acceptance Criteria

### AC1: Endpoint `POST /api/v1/metrics` accepts JSON payload with required fields

#### Scenarios

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 1.3-UNIT-001 | Unit        | P0       | Validate required fields present | Pure validation logic (StoreMetricRequest) |
| 1.3-UNIT-002 | Unit        | P1       | Validate field formats (date, numeric) | Pure validation logic |
| 1.3-INT-001  | Integration | P0       | Valid Single Payload -> 202 Accepted | Verify controller/request interaction |

### AC2: Endpoint supports bulk ingestion (array of metric objects)

#### Scenarios

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 1.3-UNIT-003 | Unit        | P0       | Validate array structure | Validation logic for root array |
| 1.3-UNIT-004 | Unit        | P1       | Validate mixed valid/invalid in bulk | Partial failure or full rejection logic |
| 1.3-INT-002  | Integration | P0       | Valid Bulk Payload -> 202 Accepted | Verify bulk handling in controller |
| 1.3-INT-003  | Integration | P2       | Max Batch Size Enforced | Verify payload size limits (Risk PERF-001) |

### AC3: API returns `202 Accepted` status code for valid payloads

#### Scenarios

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 1.3-INT-004  | Integration | P0       | Response Status Code check | HTTP Contract verification |
| 1.3-INT-005  | Integration | P1       | Tenant Auth Middleware | Security boundary check (Risk SEC-002) |

### AC4: Basic validation ensures `metric_name` and `value` are present

#### Scenarios

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 1.3-UNIT-005 | Unit        | P1       | Missing required fields -> 422 | Validation failure response logic |
| 1.3-E2E-001  | E2E         | P2       | Client Library Simulation | End-to-end client usage simulation |

## Risk Coverage

| Risk ID  | Risk Title             | Mitigating Test Scenario(s) |
| -------- | ---------------------- | --------------------------- |
| SEC-001  | Rate Limiting / DoS    | 1.3-INT-005 (Auth Check), *Additional Load Test (Outside scope of functional)* |
| PERF-001 | Large Bulk Payloads    | 1.3-INT-003 (Max Batch Size) |
| DATA-001 | Malformed Data in Bulk | 1.3-UNIT-004 (Mixed Validation) |
| SEC-002  | Tenant Context Leakage | 1.3-INT-005 (Auth Check) |

## Recommended Execution Order

1. **P0 Unit tests**: 1.3-UNIT-001, 1.3-UNIT-003 (Request Validation)
2. **P0 Integration tests**: 1.3-INT-001, 1.3-INT-002, 1.3-INT-004 (Happy Paths)
3. **P1 Unit tests**: 1.3-UNIT-002, 1.3-UNIT-005 (Edge cases)
4. **P1 Integration tests**: 1.3-INT-005 (Security)
5. **P2 Tests**: 1.3-INT-003 (Performance), 1.3-E2E-001 (Client Sim)
