# Test Design: Story 4.1 Automated Downsampling

Date: 2026-01-18
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 11
- Unit tests: 3 (27%)
- Integration tests: 7 (64%)
- E2E tests: 1 (9%)
- Priority distribution: P0: 5, P1: 4, P2: 2

## Test Scenarios by Acceptance Criteria

### AC1: Laravel Scheduler or background worker runs every minute

#### Scenarios

| ID | Level | Priority | Test | Justification |
| :--- | :--- | :--- | :--- | :--- |
| 4.1-INT-001 | Integration | P0 | Schedule frequency check | Ensures command is registered with correct cron frequency in Laravel console. |
| 4.1-INT-002 | Integration | P1 | Job overlap prevention | Verifies `withoutOverlapping()` is applied to prevent resource exhaustion. |

### AC2: Aggregated data stored in metrics_1m and metrics_5m

#### Scenarios

| ID | Level | Priority | Test | Justification |
| :--- | :--- | :--- | :--- | :--- |
| 4.1-UNIT-001 | Unit | P0 | Average calculation logic | Pure logic test for the averaging math given a set of raw data points. |
| 4.1-INT-003 | Integration | P0 | End-to-end aggregation flow | Inserts raw data, runs job, verifies records in rollup tables. |
| 4.1-INT-004 | Integration | P1 | Multi-tenant isolation | Ensures rollups for Tenant A do not include data from Tenant B. |
| 4.1-INT-005 | Integration | P2 | Empty window handling | Verifies job behavior when no raw data exists for a time window. |

### AC3: Retention policy implemented

#### Scenarios

| ID | Level | Priority | Test | Justification |
| :--- | :--- | :--- | :--- | :--- |
| 4.1-UNIT-002 | Unit | P1 | Retention date math | Validates the calculation of the "cutoff" timestamps for different resolutions. |
| 4.1-INT-006 | Integration | P0 | Retention job execution | Verifies records older than the threshold are deleted and newer ones remain. |

### AC4: API supports resolution parameter

#### Scenarios

| ID | Level | Priority | Test | Justification |
| :--- | :--- | :--- | :--- | :--- |
| 4.1-UNIT-003 | Unit | P2 | Resolution validation | Ensures invalid resolution parameters (e.g., '1h') are rejected with 422. |
| 4.1-INT-007 | Integration | P1 | Data source selection | Verifies that `resolution=1m` queries the `metrics_1m` table. |
| 4.1-E2E-001 | E2E | P1 | Historical trend journey | User requests 5m historical data via API and receives correct format/values. |

## Risk Coverage (Reference: 4.1-risk-20260118.md)

| Risk ID | Mitigation Test(s) |
| :--- | :--- |
| PERF-003 (Large Volume) | 4.1-INT-003 (with large dataset) |
| PERF-001 (Overlap) | 4.1-INT-002 |
| OPS-001 (Catch-up) | 4.1-INT-003 (testing specific historical windows) |
| DATA-001 (Retention) | 4.1-INT-006 |

## Recommended Execution Order

1. **4.1-UNIT-001, 002, 003**: Fast logic validation.
2. **4.1-INT-001, 003, 006**: Core functionality (P0 Integration).
3. **4.1-INT-007, 004, 002**: Critical integration paths (P1).
4. **4.1-E2E-001**: Final system validation.
5. **4.1-INT-005**: Edge cases.
