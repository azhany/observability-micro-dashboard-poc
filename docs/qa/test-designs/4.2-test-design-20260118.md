# Test Design: Story 4.2 Stateful Alerting Engine

Date: 2026-01-18
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 12
- Unit tests: 4 (33%)
- Integration tests: 7 (58%)
- E2E tests: 1 (9%)
- Priority distribution: P0: 6, P1: 4, P2: 2

## Test Scenarios by Acceptance Criteria

### AC1 & AC4: Schema and History Tracking

#### Scenarios

| ID | Level | Priority | Test | Justification |
| :--- | :--- | :--- | :--- | :--- |
| 4.2-INT-001 | Integration | P0 | Alert Rule Persistence | Verifies CRUD operations for AlertRules and correct UUID handling. |
| 4.2-INT-002 | Integration | P1 | History Audit Trail | Ensures every state transition creates a corresponding entry in the `alerts` history table. |

### AC2: Periodic Evaluator Job

#### Scenarios

| ID | Level | Priority | Test | Justification |
| :--- | :--- | :--- | :--- | :--- |
| 4.2-INT-003 | Integration | P0 | Schedule registration | Verifies the evaluator command is scheduled at the correct sub-minute interval. |
| 4.2-INT-004 | Integration | P1 | Query performance/indexing | Uses `EXPLAIN` or performance logs to verify the evaluation query uses the expected indexes. |
| 4.2-INT-005 | Integration | P1 | Overlap prevention | Verifies the job does not run concurrently if a previous execution is stalled. |

### AC3: Stateful Transitions (OK -> PENDING -> FIRING)

#### Scenarios

| ID | Level | Priority | Test | Justification |
| :--- | :--- | :--- | :--- | :--- |
| 4.2-UNIT-001 | Unit | P0 | OK to PENDING transition | Logic test: Threshold breached, state moves to PENDING, timer starts. |
| 4.2-UNIT-002 | Unit | P0 | PENDING to FIRING transition | Logic test: Threshold remains breached beyond `duration`, state moves to FIRING. |
| 4.2-UNIT-003 | Unit | P0 | PENDING reset (Recovery) | Logic test: Threshold drops below limit during PENDING, state returns to OK and timer resets. |
| 4.2-UNIT-004 | Unit | P1 | FIRING to OK transition | Logic test: Threshold drops below limit while FIRING, state returns to OK immediately. |
| 4.2-INT-006 | Integration | P0 | Multi-tenant isolation | Ensures metrics from Tenant A do not trigger alert rules owned by Tenant B. |
| 4.2-INT-007 | Integration | P2 | Operator variety | Validates all operators (>, <, =, >=, <=) work correctly against metric values. |

### System Validation

#### Scenarios

| ID | Level | Priority | Test | Justification |
| :--- | :--- | :--- | :--- | :--- |
| 4.2-E2E-001 | E2E | P1 | Full Alert Lifecycle | Create rule -> Ingest breaching metrics -> Wait duration -> Verify `FIRING` state in API/DB. |

## Risk Coverage (Reference: 4.2-risk-20260118.md)

| Risk ID | Mitigation Test(s) |
| :--- | :--- |
| OPS-001 (Alert Flapping) | 4.2-UNIT-003, 4.2-UNIT-004 |
| PERF-004 (Query Overhead) | 4.2-INT-004 |
| TECH-003 (State Persistence) | 4.2-INT-002 |
| SEC-001 (Tenant Leakage) | 4.2-INT-006 |

## Recommended Execution Order

1. **4.2-UNIT-001 through 004**: Validate the state machine logic first as it's the most complex code.
2. **4.2-INT-006**: Ensure security/isolation is baked in.
3. **4.2-INT-001, 003**: Basic infrastructure and scheduling.
4. **4.2-INT-002, 004, 005**: Advanced operational and performance verification.
5. **4.2-E2E-001**: Final sanity check.
