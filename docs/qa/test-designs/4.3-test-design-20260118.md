# Test Design: Story 4.3 Notification Dispatch (Webhook & Email)

Date: 2026-01-18
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 10
- Unit tests: 3 (30%)
- Integration tests: 6 (60%)
- E2E tests: 1 (10%)
- Priority distribution: P0: 5, P1: 3, P2: 2

## Test Scenarios by Acceptance Criteria

### AC1 & AC4: Dispatcher Core & Transition Logic

#### Scenarios

| ID | Level | Priority | Test | Justification |
| :--- | :--- | :--- | :--- | :--- |
| 4.3-UNIT-001 | Unit | P0 | Transition detection (OK -> FIRING) | Verifies the dispatcher triggers when the state changes to FIRING. |
| 4.3-UNIT-002 | Unit | P0 | Suppression (FIRING -> FIRING) | Verifies NO notification is triggered if the alert was already in FIRING state. |
| 4.3-INT-001 | Integration | P0 | Notification Queuing | Ensures notifications are pushed to the queue and not sent synchronously during evaluation. |

### AC2: Webhook Channel

#### Scenarios

| ID | Level | Priority | Test | Justification |
| :--- | :--- | :--- | :--- | :--- |
| 4.3-UNIT-003 | Unit | P1 | Webhook Payload Format | Validates the JSON structure contains Tenant, Metric, Value, and Threshold. |
| 4.3-INT-002 | Integration | P0 | Webhook HTTP POST | Uses `Http::fake()` to verify the dispatcher makes a POST request to the configured URL. |
| 4.3-INT-003 | Integration | P1 | Webhook Retry Policy | Verifies that a 500 response from the webhook endpoint triggers a job retry with backoff. |

### AC3: Email Channel

#### Scenarios

| ID | Level | Priority | Test | Justification |
| :--- | :--- | :--- | :--- | :--- |
| 4.3-INT-004 | Integration | P0 | Email Dispatch | Uses `Mail::fake()` or `Notification::fake()` to verify an email is sent to the tenant's address. |
| 4.3-INT-005 | Integration | P2 | Email Content Rendering | Verifies the mailable contains the correct alert details in the body. |

### Configuration & System Validation

#### Scenarios

| ID | Level | Priority | Test | Justification |
| :--- | :--- | :--- | :--- | :--- |
| 4.3-INT-006 | Integration | P1 | Tenant Settings Retrieval | Verifies the dispatcher correctly pulls webhook/email settings from the tenant's JSON settings field. |
| 4.3-E2E-001 | E2E | P1 | End-to-End Alert to Notification | Simulate metric breach -> Wait for evaluator -> Verify webhook/email received in test environment. |

## Risk Coverage (Reference: 4.3-risk-20260118.md)

| Risk ID | Mitigation Test(s) |
| :--- | :--- |
| TECH-004 (Webhook Failure) | 4.3-INT-003 (Retries) |
| OPS-002 (Notification Spam) | 4.3-UNIT-002 (Suppression) |
| DATA-003 (Malformed Config) | 4.3-INT-006 |

## Recommended Execution Order

1. **4.3-UNIT-001, 002**: Validate the core "notify once" logic.
2. **4.3-INT-002, 004**: Core delivery verification (P0).
3. **4.3-INT-003**: Resilience/Retry testing.
4. **4.3-INT-006, 001**: Infrastructure and config.
5. **4.3-E2E-001**: Final system flow validation.
